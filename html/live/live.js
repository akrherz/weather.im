Object.keys||(Object.keys=function(){var d=Object.prototype.hasOwnProperty,f=!{toString:null}.propertyIsEnumerable("toString"),k="toString toLocaleString valueOf hasOwnProperty isPrototypeOf propertyIsEnumerable constructor".split(" "),m=k.length;return function(p){if("object"!==typeof p&&("function"!==typeof p||null===p))throw new TypeError("Object.keys called on non-object");var q=[],u;for(u in p)d.call(p,u)&&q.push(u);if(f)for(u=0;u<m;u++)d.call(p,k[u])&&q.push(k[u]);return q}}());
Array.prototype.forEach||(Array.prototype.forEach=function(d){if(void 0===this||null===this)throw new TypeError;var f=Object(this),k=f.length>>>0;if("function"!==typeof d)throw new TypeError;for(var m=2<=arguments.length?arguments[1]:void 0,p=0;p<k;p++)p in f&&d.call(m,f[p],p,f)});Ext.override(Date,{toUTC:function(){return this.add(Date.MINUTE,this.getTimezoneOffset())},fromUTC:function(){return this.add(Date.MINUTE,-this.getTimezoneOffset())}});
Ext.override(Ext.Panel,{setIconCls:function(d){Ext.fly(this.ownerCt.getTabEl(this)).child(".x-tab-strip-text").replaceClass(this.iconCls,d);this.setIconClass(d)}});
Ext.override(Ext.Element,{printCSS:null,printStyle:!1,printTitle:document.title,print:function(d){Ext.apply(this,d);d=Ext.get(this.id).dom;this.isGrid&&(d=d.parentNode);var f=document.getElementById("printcontainer"),k=document.getElementById("printframe"),m="";f&&(k&&f.removeChild(k),d.removeChild(f));for(k=0;k<d.attributes.length;k++)if(Ext.isEmpty(d.attributes[k].value)||"null"!=d.attributes[k].value.toLowerCase())if(f=Ext.isEmpty(d.attributes[k].value)?'{0}="true" ':'{0}="{1}" ',this.printStyle||
"style"!=d.attributes[k].name.toLowerCase())m+=String.format(f,d.attributes[k].name,d.attributes[k].value);f="";if(this.printCSS)for(Ext.isArray(this.printCSS)||(this.printCSS=[this.printCSS]),k=0;k<this.printCSS.length;k++)f+=String.format('<link rel="stylesheet" type="text/css" href="{0}"/>',this.printCSS[k]);m=String.format('<HTML><HEAD>{0}<TITLE>{1}</TITLE></HEAD><BODY onload="{2}"><DIV {3}>{4}</DIV></BODY></HTML>',f,this.printTitle,"",m,d.innerHTML);f=document.createElement("div");f.setAttribute("style",
"width:0px;height:0px;"+(Ext.isSafari?"display:none;":"visibility:hidden;"));f.setAttribute("id","printcontainer");d.appendChild(f);Ext.isIE&&(f.style.display="none");k=document.createElement("iframe");k.setAttribute("id","printframe");k.setAttribute("name","printframe");f.appendChild(k);k.contentWindow.document.open();k.contentWindow.document.write(m);k.contentWindow.document.close();this.isGrid&&(d=Ext.get(k.contentWindow.document.body),d=Ext.get(d.first().dom.parentNode),d.child("div.x-panel-body").setStyle("height",
""),d.child("div.x-grid3").setStyle("height",""),d.child("div.x-grid3-scroller").setStyle("height",""));Ext.isIE?k.contentWindow.document.execCommand("print"):k.contentWindow.print()}});(function(d,f){"object"===typeof exports&&"undefined"!==typeof module?f(exports):"function"===typeof define&&define.amd?define(["exports"],f):(d="undefined"!==typeof globalThis?globalThis:d||self,f(d.strophe={}))})(this,function(d){function f(){if("undefined"===typeof document)try{return(new (require("@xmldom/xmldom").DOMImplementation)).createDocument("jabber:client","strophe",null)}catch(b){throw Error('You must install the "@xmldom/xmldom" package to use Strophe in nodejs.');}if(void 0===document.implementation.createDocument||
document.implementation.createDocument&&document.documentMode&&10>document.documentMode){a:{const b="Msxml2.DOMDocument.6.0 Msxml2.DOMDocument.5.0 Msxml2.DOMDocument.4.0 MSXML2.DOMDocument.3.0 MSXML2.DOMDocument MSXML.DOMDocument Microsoft.XMLDOM".split(" ");for(let e=0;e<b.length;e++)try{var a=new ActiveXObject(b[e]);break a}catch(g){}a=void 0}a.appendChild(a.createElement("strophe"));return a}return document.implementation.createDocument("jabber:client","strophe",null)}function k(a,b){a[b>>5]|=
128<<24-b%32;a[(b+64>>9<<4)+15]=b;b=Array(80);var e=1732584193,g=-271733879,l=-1732584194,n=271733878,w=-1009589776,x,y;for(x=0;x<a.length;x+=16){var r=e;var P=g;var R=l;var V=n;var W=w;for(y=0;80>y;y++){if(16>y)b[y]=a[x+y];else{var L=b[y-3]^b[y-8]^b[y-14]^b[y-16];b[y]=L<<1|L>>>31}L=e<<5|e>>>27;var X=20>y?g&l|~g&n:40>y?g^l^n:60>y?g&l|g&n|l&n:g^l^n;L=p(p(L,X),p(p(w,b[y]),20>y?1518500249:40>y?1859775393:60>y?-1894007588:-899497514));w=n;n=l;l=g<<30|g>>>2;g=e;e=L}e=p(e,r);g=p(g,P);l=p(l,R);n=p(n,V);
w=p(w,W)}return[e,g,l,n,w]}function m(a,b){var e=q(a);16<e.length&&(e=k(e,8*a.length));var g=Array(16);a=Array(16);for(var l=0;16>l;l++)g[l]=e[l]^909522486,a[l]=e[l]^1549556828;b=k(g.concat(q(b)),512+8*b.length);return k(a.concat(b),672)}function p(a,b){var e=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(e>>16)<<16|e&65535}function q(a){for(var b=[],e=0;e<8*a.length;e+=8)b[e>>5]|=(a.charCodeAt(e/8)&255)<<24-e%32;return b}function u(a){for(var b="",e,g,l=0;l<4*a.length;l+=3)for(e=(a[l>>2]>>8*(3-l%4)&
255)<<16|(a[l+1>>2]>>8*(3-(l+1)%4)&255)<<8|a[l+2>>2]>>8*(3-(l+2)%4)&255,g=0;4>g;g++)b=8*l+6*g>32*a.length?b+"=":b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(e>>6*(3-g)&63);return b}function v(a){for(var b="",e=0;e<32*a.length;e+=8)b+=String.fromCharCode(a[e>>5]>>>24-e%32&255);return b}function z(a,b){return new h.Builder(a,b)}function O(a){return new h.Builder("message",a)}function F(a){return new h.Builder("iq",a)}function G(a){return new h.Builder("presence",a)}var J=
"undefined"!==typeof global?global:"undefined"!==typeof self?self:"undefined"!==typeof window?window:{};const S=function(){let a=J.WebSocket;if("undefined"===typeof a)try{a=require("ws")}catch(b){throw Error('You must install the "ws" package to use Strophe in nodejs.');}return a}(),H=function(){let a=J.DOMParser;if("undefined"===typeof a)try{a=require("@xmldom/xmldom").DOMParser}catch(b){throw Error('You must install the "@xmldom/xmldom" package to use Strophe in nodejs.');}return a}(),I=function(a,
b){const e=(a&65535)+(b&65535);return(a>>16)+(b>>16)+(e>>16)<<16|e&65535},T=function(a){if("string"!==typeof a)throw Error("str2binl was passed a non-string");const b=[];for(let e=0;e<8*a.length;e+=8)b[e>>5]|=(a.charCodeAt(e/8)&255)<<e%32;return b},A=function(a,b,e,g,l,n){a=I(I(b,a),I(g,n));return I(a<<l|a>>>32-l,e)},B=function(a,b,e,g,l,n,w){return A(b&e|~b&g,a,b,l,n,w)},C=function(a,b,e,g,l,n,w){return A(b&g|e&~g,a,b,l,n,w)},D=function(a,b,e,g,l,n,w){return A(e^(b|~g),a,b,l,n,w)},U=function(a,b){a[b>>
5]|=128<<b%32;a[(b+64>>>9<<4)+14]=b;b=1732584193;let e=-271733879,g=-1732584194,l=271733878,n,w,x,y;for(let r=0;r<a.length;r+=16)n=b,w=e,x=g,y=l,b=B(b,e,g,l,a[r+0],7,-680876936),l=B(l,b,e,g,a[r+1],12,-389564586),g=B(g,l,b,e,a[r+2],17,606105819),e=B(e,g,l,b,a[r+3],22,-1044525330),b=B(b,e,g,l,a[r+4],7,-176418897),l=B(l,b,e,g,a[r+5],12,1200080426),g=B(g,l,b,e,a[r+6],17,-1473231341),e=B(e,g,l,b,a[r+7],22,-45705983),b=B(b,e,g,l,a[r+8],7,1770035416),l=B(l,b,e,g,a[r+9],12,-1958414417),g=B(g,l,b,e,a[r+10],
17,-42063),e=B(e,g,l,b,a[r+11],22,-1990404162),b=B(b,e,g,l,a[r+12],7,1804603682),l=B(l,b,e,g,a[r+13],12,-40341101),g=B(g,l,b,e,a[r+14],17,-1502002290),e=B(e,g,l,b,a[r+15],22,1236535329),b=C(b,e,g,l,a[r+1],5,-165796510),l=C(l,b,e,g,a[r+6],9,-1069501632),g=C(g,l,b,e,a[r+11],14,643717713),e=C(e,g,l,b,a[r+0],20,-373897302),b=C(b,e,g,l,a[r+5],5,-701558691),l=C(l,b,e,g,a[r+10],9,38016083),g=C(g,l,b,e,a[r+15],14,-660478335),e=C(e,g,l,b,a[r+4],20,-405537848),b=C(b,e,g,l,a[r+9],5,568446438),l=C(l,b,e,g,a[r+
14],9,-1019803690),g=C(g,l,b,e,a[r+3],14,-187363961),e=C(e,g,l,b,a[r+8],20,1163531501),b=C(b,e,g,l,a[r+13],5,-1444681467),l=C(l,b,e,g,a[r+2],9,-51403784),g=C(g,l,b,e,a[r+7],14,1735328473),e=C(e,g,l,b,a[r+12],20,-1926607734),b=A(e^g^l,b,e,a[r+5],4,-378558),l=A(b^e^g,l,b,a[r+8],11,-2022574463),g=A(l^b^e,g,l,a[r+11],16,1839030562),e=A(g^l^b,e,g,a[r+14],23,-35309556),b=A(e^g^l,b,e,a[r+1],4,-1530992060),l=A(b^e^g,l,b,a[r+4],11,1272893353),g=A(l^b^e,g,l,a[r+7],16,-155497632),e=A(g^l^b,e,g,a[r+10],23,-1094730640),
b=A(e^g^l,b,e,a[r+13],4,681279174),l=A(b^e^g,l,b,a[r+0],11,-358537222),g=A(l^b^e,g,l,a[r+3],16,-722521979),e=A(g^l^b,e,g,a[r+6],23,76029189),b=A(e^g^l,b,e,a[r+9],4,-640364487),l=A(b^e^g,l,b,a[r+12],11,-421815835),g=A(l^b^e,g,l,a[r+15],16,530742520),e=A(g^l^b,e,g,a[r+2],23,-995338651),b=D(b,e,g,l,a[r+0],6,-198630844),l=D(l,b,e,g,a[r+7],10,1126891415),g=D(g,l,b,e,a[r+14],15,-1416354905),e=D(e,g,l,b,a[r+5],21,-57434055),b=D(b,e,g,l,a[r+12],6,1700485571),l=D(l,b,e,g,a[r+3],10,-1894986606),g=D(g,l,b,e,
a[r+10],15,-1051523),e=D(e,g,l,b,a[r+1],21,-2054922799),b=D(b,e,g,l,a[r+8],6,1873313359),l=D(l,b,e,g,a[r+15],10,-30611744),g=D(g,l,b,e,a[r+6],15,-1560198380),e=D(e,g,l,b,a[r+13],21,1309151649),b=D(b,e,g,l,a[r+4],6,-145523070),l=D(l,b,e,g,a[r+11],10,-1120210379),g=D(g,l,b,e,a[r+2],15,718787259),e=D(e,g,l,b,a[r+9],21,-343485551),b=I(b,n),e=I(e,w),g=I(g,x),l=I(l,y);return[b,e,g,l]},Y={hexdigest:function(a){a=U(T(a),8*a.length);let b="";for(let e=0;e<4*a.length;e++)b+="0123456789abcdef".charAt(a[e>>2]>>
e%4*8+4&15)+"0123456789abcdef".charAt(a[e>>2]>>e%4*8&15);return b},hash:function(a){a=U(T(a),8*a.length);let b="";for(let e=0;e<32*a.length;e+=8)b+=String.fromCharCode(a[e>>5]>>>e%32&255);return b}};class K{constructor(a,b,e){this.mechname=a;this.isClientFirst=b;this.priority=e}test(){return!0}onStart(a){this._connection=a}onChallenge(a,b){throw Error("You should implement challenge handling!");}clientChallenge(a){if(!this.isClientFirst)throw Error("clientChallenge should not be called if isClientFirst is false!");
return this.onChallenge(a)}onFailure(){this._connection=null}onSuccess(){this._connection=null}}class Z extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"ANONYMOUS",1<arguments.length&&void 0!==arguments[1]?arguments[1]:!1,2<arguments.length&&void 0!==arguments[2]?arguments[2]:20)}test(a){return null===a.authcid}}class aa extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"EXTERNAL",1<arguments.length&&void 0!==arguments[1]?arguments[1]:
!0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:10)}onChallenge(a){return a.authcid===a.authzid?"":a.authzid}}const M={utf16to8:function(a){var b,e="",g=a.length;for(b=0;b<g;b++){var l=a.charCodeAt(b);0<=l&&127>=l?e+=a.charAt(b):(2047<l?(e+=String.fromCharCode(224|l>>12&15),e+=String.fromCharCode(128|l>>6&63)):e+=String.fromCharCode(192|l>>6&31),e+=String.fromCharCode(128|l>>0&63))}return e},addCookies:function(a){a=a||{};for(const b in a)if(Object.prototype.hasOwnProperty.call(a,b)){let e=
"",g="",l="";const n=a[b],w="object"===typeof n,x=escape(unescape(w?n.value:n));w&&(e=n.expires?";expires="+n.expires:"",g=n.domain?";domain="+n.domain:"",l=n.path?";path="+n.path:"");document.cookie=b+"="+x+e+g+l}}};class ba extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"OAUTHBEARER",1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:40)}test(a){return null!==a.pass}onChallenge(a){let b="n,";null!==
a.authcid&&(b=b+"a="+a.authzid);b=b+",\u0001auth=Bearer "+a.pass;return M.utf16to8(b+"\u0001\u0001")}}class ca extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"PLAIN",1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:50)}test(a){return null!==a.authcid}onChallenge(a){const {authcid:b,authzid:e,domain:g,pass:l}=a;if(!g)throw Error("SASLPlain onChallenge: domain is not defined!");a=(e!==`${b}@${g}`?e:
"")+"\x00"+b;a+="\x00";a+=l;return M.utf16to8(a)}}const E={b64_hmac_sha1:function(a,b){return u(m(a,b))},b64_sha1:function(a){return u(k(q(a),8*a.length))},binb2str:v,core_hmac_sha1:m,str_hmac_sha1:function(a,b){return v(m(a,b))},str_sha1:function(a){return v(k(q(a),8*a.length))}};class da extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"SCRAM-SHA-1",1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:
60)}test(a){return null!==a.authcid}onChallenge(a,b){var e;let g="c=biws,",l=`${a._sasl_data["client-first-message-bare"]},${b},`;var n=a._sasl_data.cnonce;for(e=/([a-z]+)=([^,]+)(,|$)/;b.match(e);){const r=b.match(e);b=b.replace(r[0],"");switch(r[1]){case "r":var w=r[2];break;case "s":var x=r[2];break;case "i":var y=r[2]}}if(w.slice(0,n.length)!==n)return a._sasl_data={},a._sasl_failure_cb();g+="r="+w;l+=g;x=atob(x);x+="\x00\x00\x00\u0001";w=M.utf16to8(a.pass);x=b=E.core_hmac_sha1(w,x);for(n=1;n<
y;n++){e=E.core_hmac_sha1(w,E.binb2str(b));for(b=0;5>b;b++)x[b]^=e[b];b=e}x=E.binb2str(x);y=E.core_hmac_sha1(x,"Client Key");b=E.str_hmac_sha1(x,"Server Key");x=E.core_hmac_sha1(E.str_sha1(E.binb2str(y)),l);a._sasl_data["server-signature"]=E.b64_hmac_sha1(b,l);for(b=0;5>b;b++)y[b]^=x[b];return g+=",p="+btoa(E.binb2str(y))}clientChallenge(a,b){b=b||Y.hexdigest(""+1234567890*Math.random());let e="n="+M.utf16to8(a.authcid);e=e+",r="+b;a._sasl_data.cnonce=b;a._sasl_data["client-first-message-bare"]=e;
return"n,,"+e}}class ea extends K{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:"X-OAUTH2",1<arguments.length&&void 0!==arguments[1]?arguments[1]:!0,2<arguments.length&&void 0!==arguments[2]?arguments[2]:30)}test(a){return null!==a.pass}onChallenge(a){let b="\x00";null!==a.authcid&&(b+=a.authzid);b=b+"\x00"+a.pass;return M.utf16to8(b)}}var Q={atob:function(a){if(0===arguments.length)throw new TypeError("1 argument required, but only 0 present.");a=`${a}`.replace(/[ \t\n\f\r]/g,
"");0===a.length%4&&(a=a.replace(/==?$/,""));if(1===a.length%4||/[^+/0-9A-Za-z]/.test(a))return null;let b="";var e=0;let g=0;for(let l=0;l<a.length;l++){e<<=6;const n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".indexOf(a[l]);e|=0>n?NaN:n;g+=6;24===g&&(b+=String.fromCharCode((e&16711680)>>16),b+=String.fromCharCode((e&65280)>>8),b+=String.fromCharCode(e&255),e=g=0)}12===g?b+=String.fromCharCode(e>>4):18===g&&(e>>=2,b+=String.fromCharCode((e&65280)>>8),b+=String.fromCharCode(e&
255));return b},btoa:function(a){if(0===arguments.length)throw new TypeError("1 argument required, but only 0 present.");let b;a=`${a}`;for(b=0;b<a.length;b++)if(255<a.charCodeAt(b))return null;var e="";for(b=0;b<a.length;b+=3){const l=[void 0,void 0,void 0,void 0];l[0]=a.charCodeAt(b)>>2;l[1]=(a.charCodeAt(b)&3)<<4;a.length>b+1&&(l[1]|=a.charCodeAt(b+1)>>4,l[2]=(a.charCodeAt(b+1)&15)<<2);a.length>b+2&&(l[2]|=a.charCodeAt(b+2)>>6,l[3]=a.charCodeAt(b+2)&63);for(let n=0;n<l.length;n++)if("undefined"===
typeof l[n])e+="=";else{var g=l[n];g=0<=g&&64>g?"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/"[g]:void 0;e+=g}}return e}};const h={VERSION:"1.5.0",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",
STREAM:"http://etherx.jabber.org/streams",FRAMING:"urn:ietf:params:xml:ns:xmpp-framing",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:"a blockquote br cite em img li ol p span strong ul body".split(" "),attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt",
"style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:"background-color color font-family font-size font-style font-weight margin-left margin-right text-align text-decoration".split(" "),validTag(a){for(let b=0;b<h.XHTML.tags.length;b++)if(a===h.XHTML.tags[b])return!0;return!1},validAttribute(a,b){if("undefined"!==typeof h.XHTML.attributes[a]&&0<h.XHTML.attributes[a].length)for(let e=0;e<h.XHTML.attributes[a].length;e++)if(b===h.XHTML.attributes[a][e])return!0;
return!1},validCSS(a){for(let b=0;b<h.XHTML.css.length;b++)if(a===h.XHTML.css[b])return!0;return!1}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8,REDIRECT:9,CONNTIMEOUT:10,BINDREQUIRED:11,ATTACHFAIL:12},ErrorCondition:{BAD_FORMAT:"bad-format",CONFLICT:"conflict",MISSING_JID_NODE:"x-strophe-bad-non-anon-jid",NO_AUTH_MECH:"no-auth-mech",UNKNOWN_REASON:"unknown"},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,
TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:.1,addNamespace(a,b){h.NS[a]=b},forEachChild(a,b,e){for(let g=0;g<a.childNodes.length;g++){const l=a.childNodes[g];l.nodeType!==h.ElementType.NORMAL||b&&!this.isTagEqual(l,b)||e(l)}},isTagEqual(a,b){return a.tagName===b},_xmlGenerator:null,xmlGenerator(){h._xmlGenerator||(h._xmlGenerator=f());return h._xmlGenerator},xmlElement(a){if(!a)return null;const b=h.xmlGenerator().createElement(a);for(let e=1;e<arguments.length;e++){const g=arguments[e];
if(g)if("string"===typeof g||"number"===typeof g)b.appendChild(h.xmlTextNode(g));else if("object"===typeof g&&"function"===typeof g.sort)for(let l=0;l<g.length;l++){const n=g[l];"object"===typeof n&&"function"===typeof n.sort&&void 0!==n[1]&&null!==n[1]&&b.setAttribute(n[0],n[1])}else if("object"===typeof g)for(const l in g)Object.prototype.hasOwnProperty.call(g,l)&&void 0!==g[l]&&null!==g[l]&&b.setAttribute(l,g[l])}return b},xmlescape(a){a=a.replace(/&/g,"&amp;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,
"&gt;");a=a.replace(/'/g,"&apos;");return a=a.replace(/"/g,"&quot;")},xmlunescape(a){a=a.replace(/&amp;/g,"&");a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&apos;/g,"'");return a=a.replace(/&quot;/g,'"')},xmlTextNode(a){return h.xmlGenerator().createTextNode(a)},xmlHtmlNode(a){let b;H?b=(new H).parseFromString(a,"text/xml"):(b=new ActiveXObject("Microsoft.XMLDOM"),b.async="false",b.loadXML(a));return b},getText(a){if(!a)return null;let b="";0===a.childNodes.length&&a.nodeType===
h.ElementType.TEXT&&(b+=a.nodeValue);for(let e=0;e<a.childNodes.length;e++)a.childNodes[e].nodeType===h.ElementType.TEXT&&(b+=a.childNodes[e].nodeValue);return h.xmlescape(b)},copyElement(a){let b;if(a.nodeType===h.ElementType.NORMAL){b=h.xmlElement(a.tagName);for(var e=0;e<a.attributes.length;e++)b.setAttribute(a.attributes[e].nodeName,a.attributes[e].value);for(e=0;e<a.childNodes.length;e++)b.appendChild(h.copyElement(a.childNodes[e]))}else a.nodeType===h.ElementType.TEXT&&(b=h.xmlGenerator().createTextNode(a.nodeValue));
return b},createHtml(a){let b;if(a.nodeType===h.ElementType.NORMAL){var e=a.nodeName.toLowerCase();if(h.XHTML.validTag(e))try{b=h.xmlElement(e);for(let g=0;g<h.XHTML.attributes[e].length;g++){const l=h.XHTML.attributes[e][g];let n=a.getAttribute(l);if("undefined"!==typeof n&&null!==n&&""!==n&&!1!==n&&0!==n)if("style"===l&&"object"===typeof n&&"undefined"!==typeof n.cssText&&(n=n.cssText),"style"===l){const w=[],x=n.split(";");for(let y=0;y<x.length;y++){const r=x[y].split(":"),P=r[0].replace(/^\s*/,
"").replace(/\s*$/,"").toLowerCase();if(h.XHTML.validCSS(P)){const R=r[1].replace(/^\s*/,"").replace(/\s*$/,"");w.push(P+": "+R)}}0<w.length&&(n=w.join("; "),b.setAttribute(l,n))}else b.setAttribute(l,n)}for(e=0;e<a.childNodes.length;e++)b.appendChild(h.createHtml(a.childNodes[e]))}catch(g){b=h.xmlTextNode("")}else for(b=h.xmlGenerator().createDocumentFragment(),e=0;e<a.childNodes.length;e++)b.appendChild(h.createHtml(a.childNodes[e]))}else if(a.nodeType===h.ElementType.FRAGMENT)for(b=h.xmlGenerator().createDocumentFragment(),
e=0;e<a.childNodes.length;e++)b.appendChild(h.createHtml(a.childNodes[e]));else a.nodeType===h.ElementType.TEXT&&(b=h.xmlTextNode(a.nodeValue));return b},escapeNode(a){return"string"!==typeof a?a:a.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/"/g,"\\22").replace(/&/g,"\\26").replace(/'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40")},unescapeNode(a){return"string"!==typeof a?a:a.replace(/\\20/g," ").replace(/\\22/g,
'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\")},getNodeFromJid(a){return 0>a.indexOf("@")?null:a.split("@")[0]},getDomainFromJid(a){a=h.getBareJidFromJid(a);if(0>a.indexOf("@"))return a;a=a.split("@");a.splice(0,1);return a.join("@")},getResourceFromJid(a){if(!a)return null;a=a.split("/");if(2>a.length)return null;a.splice(0,1);return a.join("/")},getBareJidFromJid(a){return a?
a.split("/")[0]:null},_handleError(a){"undefined"!==typeof a.stack&&h.fatal(a.stack);a.sourceURL?h.fatal("error: "+this.handler+" "+a.sourceURL+":"+a.line+" - "+a.name+": "+a.message):a.fileName?h.fatal("error: "+this.handler+" "+a.fileName+":"+a.lineNumber+" - "+a.name+": "+a.message):h.fatal("error: "+a.message)},log(a,b){if(a===this.LogLevel.FATAL){var e;null===(e=console)||void 0===e?void 0:e.error(b)}},debug(a){this.log(this.LogLevel.DEBUG,a)},info(a){this.log(this.LogLevel.INFO,a)},warn(a){this.log(this.LogLevel.WARN,
a)},error(a){this.log(this.LogLevel.ERROR,a)},fatal(a){this.log(this.LogLevel.FATAL,a)},serialize(a){if(!a)return null;"function"===typeof a.tree&&(a=a.tree());var b=[...Array(a.attributes.length).keys()].map(e=>a.attributes[e].nodeName);b.sort();b=b.reduce((e,g)=>`${e} ${g}="${h.xmlescape(a.attributes.getNamedItem(g).value)}"`,`<${a.nodeName}`);if(0<a.childNodes.length){b+=">";for(let e=0;e<a.childNodes.length;e++){const g=a.childNodes[e];switch(g.nodeType){case h.ElementType.NORMAL:b+=h.serialize(g);
break;case h.ElementType.TEXT:b+=h.xmlescape(g.nodeValue);break;case h.ElementType.CDATA:b+="<![CDATA["+g.nodeValue+"]]\x3e"}}b+="</"+a.nodeName+">"}else b+="/>";return b},_requestId:0,_connectionPlugins:{},addConnectionPlugin(a,b){h._connectionPlugins[a]=b}};h.Builder=class{constructor(a,b){if("presence"===a||"message"===a||"iq"===a)b&&!b.xmlns?b.xmlns=h.NS.CLIENT:b||={xmlns:h.NS.CLIENT};this.node=this.nodeTree=h.xmlElement(a,b)}tree(){return this.nodeTree}toString(){return h.serialize(this.nodeTree)}up(){this.node=
this.node.parentNode;return this}root(){this.node=this.nodeTree;return this}attrs(a){for(const b in a)Object.prototype.hasOwnProperty.call(a,b)&&(void 0===a[b]?this.node.removeAttribute(b):this.node.setAttribute(b,a[b]));return this}c(a,b,e){a=h.xmlElement(a,b,e);this.node.appendChild(a);"string"!==typeof e&&"number"!==typeof e&&(this.node=a);return this}cnode(a){let b;const e=h.xmlGenerator();try{b=void 0!==e.importNode}catch(g){b=!1}a=b?e.importNode(a,!0):h.copyElement(a);this.node.appendChild(a);
this.node=a;return this}t(a){a=h.xmlTextNode(a);this.node.appendChild(a);return this}h(a){const b=h.xmlGenerator().createElement("body");b.innerHTML=a;for(a=h.createHtml(b);0<a.childNodes.length;)this.node.appendChild(a.childNodes[0]);return this}};h.Handler=function(a,b,e,g,l,n,w){this.handler=a;this.ns=b;this.name=e;this.type=g;this.id=l;this.options=w||{matchBareFromJid:!1,ignoreNamespaceFragment:!1};this.options.matchBare&&(h.warn('The "matchBare" option is deprecated, use "matchBareFromJid" instead.'),
this.options.matchBareFromJid=this.options.matchBare,delete this.options.matchBare);this.from=this.options.matchBareFromJid?n?h.getBareJidFromJid(n):null:n;this.user=!0};h.Handler.prototype={getNamespace(a){(a=a.getAttribute("xmlns"))&&this.options.ignoreNamespaceFragment&&(a=a.split("#")[0]);return a},namespaceMatch(a){let b=!1;return this.ns?(h.forEachChild(a,null,e=>{this.getNamespace(e)===this.ns&&(b=!0)}),b||this.getNamespace(a)===this.ns):!0},isMatch(a){let b=a.getAttribute("from");this.options.matchBareFromJid&&
(b=h.getBareJidFromJid(b));const e=a.getAttribute("type");return!this.namespaceMatch(a)||this.name&&!h.isTagEqual(a,this.name)||this.type&&(Array.isArray(this.type)?-1===this.type.indexOf(e):e!==this.type)||this.id&&a.getAttribute("id")!==this.id||this.from&&b!==this.from?!1:!0},run(a){let b=null;try{b=this.handler(a)}catch(e){throw h._handleError(e),e;}return b},toString(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}"}};h.TimedHandler=class{constructor(a,b){this.period=
a;this.handler=b;this.lastCalled=(new Date).getTime();this.user=!0}run(){this.lastCalled=(new Date).getTime();return this.handler()}reset(){this.lastCalled=(new Date).getTime()}toString(){return"{TimedHandler: "+this.handler+"("+this.period+")}"}};h.Connection=class{constructor(a,b){this.service=a;this.options=b||{};this.setProtocol();this.jid="";this.features=this.domain=null;this._sasl_data={};this.do_session=this.do_bind=!1;this.mechanisms={};this.timedHandlers=[];this.handlers=[];this.removeTimeds=
[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.protocolErrorHandlers={HTTP:{},websocket:{}};this._disconnectTimeout=this._idleTimeout=null;this.disconnecting=this.connected=this.authenticated=!1;this.do_authentication=!0;this.restored=this.paused=!1;this._data=[];this._uniqueId=0;this._sasl_challenge_handler=this._sasl_failure_handler=this._sasl_success_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(()=>this._onIdle(),100);M.addCookies(this.options.cookies);this.registerSASLMechanisms(this.options.mechanisms);
this.iqFallbackHandler=new h.Handler(e=>this.send(F({type:"error",id:e.getAttribute("id")}).c("error",{type:"cancel"}).c("service-unavailable",{xmlns:h.NS.STANZAS})),null,"iq",["get","set"]);for(const e in h._connectionPlugins)Object.prototype.hasOwnProperty.call(h._connectionPlugins,e)&&(a=function(){},a.prototype=h._connectionPlugins[e],this[e]=new a,this[e].init(this))}setProtocol(){const a=this.options.protocol||"";this.options.worker?this._proto=new h.WorkerWebsocket(this):0===this.service.indexOf("ws:")||
0===this.service.indexOf("wss:")||0===a.indexOf("ws")?this._proto=new h.Websocket(this):this._proto=new h.Bosh(this)}reset(){this._proto._reset();this.do_bind=this.do_session=!1;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this.restored=this.disconnecting=this.connected=this.authenticated=!1;this._data=[];this._requests=[];this._uniqueId=0}pause(){this.paused=!0}resume(){this.paused=!1}getUniqueId(a){const b="xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(e){const g=16*Math.random()|0;return("x"===e?g:g&3|8).toString(16)});return"string"===typeof a||"number"===typeof a?b+":"+a:b+""}addProtocolErrorHandler(a,b,e){this.protocolErrorHandlers[a][b]=e}connect(a,b,e,g,l,n,w){let x=7<arguments.length&&void 0!==arguments[7]?arguments[7]:3E3;this.jid=a;this.authzid=h.getBareJidFromJid(this.jid);this.authcid=w||h.getNodeFromJid(this.jid);this.pass=b;this.connect_callback=e;this.restored=this.authenticated=this.connected=this.disconnecting=!1;this.disconnection_timeout=
x;this.domain=h.getDomainFromJid(this.jid);this._changeConnectStatus(h.Status.CONNECTING,null);this._proto._connect(g,l,n)}attach(a,b,e,g,l,n,w){if(this._proto._attach)return this._proto._attach(a,b,e,g,l,n,w);a=Error('The "attach" method is not available for your connection protocol');a.name="StropheSessionError";throw a;}restore(a,b,e,g,l){if(this._sessionCachingSupported())this._proto._restore(a,b,e,g,l);else throw a=Error('The "restore" method can only be used with a BOSH connection.'),a.name=
"StropheSessionError",a;}_sessionCachingSupported(){if(this._proto instanceof h.Bosh){if(!JSON)return!1;try{sessionStorage.setItem("_strophe_","_strophe_"),sessionStorage.removeItem("_strophe_")}catch(a){return!1}return!0}return!1}xmlInput(a){}xmlOutput(a){}rawInput(a){}rawOutput(a){}nextValidRid(a){}send(a){if(null!==a){if("function"===typeof a.sort)for(let b=0;b<a.length;b++)this._queueData(a[b]);else"function"===typeof a.tree?this._queueData(a.tree()):this._queueData(a);this._proto._send()}}flush(){clearTimeout(this._idleTimeout);
this._onIdle()}sendPresence(a,b,e,g){let l=null;"function"===typeof a.tree&&(a=a.tree());let n=a.getAttribute("id");n||(n=this.getUniqueId("sendPresence"),a.setAttribute("id",n));if("function"===typeof b||"function"===typeof e){const w=this.addHandler(x=>{l&&this.deleteTimedHandler(l);"error"===x.getAttribute("type")?e&&e(x):b&&b(x)},null,"presence",null,n);g&&(l=this.addTimedHandler(g,()=>{this.deleteHandler(w);e&&e(null);return!1}))}this.send(a);return n}sendIQ(a,b,e,g){let l=null;"function"===
typeof a.tree&&(a=a.tree());let n=a.getAttribute("id");n||(n=this.getUniqueId("sendIQ"),a.setAttribute("id",n));if("function"===typeof b||"function"===typeof e){const w=this.addHandler(x=>{l&&this.deleteTimedHandler(l);const y=x.getAttribute("type");if("result"===y)b&&b(x);else if("error"===y)e&&e(x);else throw x=Error(`Got bad IQ type of ${y}`),x.name="StropheError",x;},null,"iq",["error","result"],n);g&&(l=this.addTimedHandler(g,()=>{this.deleteHandler(w);e&&e(null);return!1}))}this.send(a);return n}_queueData(a){if(null===
a||!a.tagName||!a.childNodes)throw a=Error("Cannot queue non-DOMElement."),a.name="StropheError",a;this._data.push(a)}_sendRestart(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(()=>this._onIdle(),100)}addTimedHandler(a,b){a=new h.TimedHandler(a,b);this.addTimeds.push(a);return a}deleteTimedHandler(a){this.removeTimeds.push(a)}addHandler(a,b,e,g,l,n,w){a=new h.Handler(a,b,e,g,l,n,w);this.addHandlers.push(a);return a}deleteHandler(a){this.removeHandlers.push(a);
a=this.addHandlers.indexOf(a);0<=a&&this.addHandlers.splice(a,1)}registerSASLMechanisms(a){this.mechanisms={};a=a||[h.SASLAnonymous,h.SASLExternal,h.SASLOAuthBearer,h.SASLXOAuth2,h.SASLPlain,h.SASLSHA1];a.forEach(b=>this.registerSASLMechanism(b))}registerSASLMechanism(a){a=new a;this.mechanisms[a.mechname]=a}disconnect(a){this._changeConnectStatus(h.Status.DISCONNECTING,a);a?h.warn("Disconnect was called because: "+a):h.info("Disconnect was called");this.connected?(a=!1,this.disconnecting=!0,this.authenticated&&
(a=G({xmlns:h.NS.CLIENT,type:"unavailable"})),this._disconnectTimeout=this._addSysTimedHandler(this.disconnection_timeout,this._onDisconnectTimeout.bind(this)),this._proto._disconnect(a)):(h.warn("Disconnect was called before Strophe connected to the server"),this._proto._abortAllRequests(),this._doDisconnect())}_changeConnectStatus(a,b,e){for(const g in h._connectionPlugins)if(Object.prototype.hasOwnProperty.call(h._connectionPlugins,g)){const l=this[g];if(l.statusChanged)try{l.statusChanged(a,b)}catch(n){h.error(`${g} plugin caused an exception changing status: ${n}`)}}if(this.connect_callback)try{this.connect_callback(a,
b,e)}catch(g){h._handleError(g),h.error(`User connection callback caused an exception: ${g}`)}}_doDisconnect(a){"number"===typeof this._idleTimeout&&clearTimeout(this._idleTimeout);null!==this._disconnectTimeout&&(this.deleteTimedHandler(this._disconnectTimeout),this._disconnectTimeout=null);h.debug("_doDisconnect was called");this._proto._doDisconnect();this.restored=this.disconnecting=this.authenticated=!1;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=
[];this.addHandlers=[];this._changeConnectStatus(h.Status.DISCONNECTED,a);this.connected=!1}_dataRecv(a,b){a=this._proto._reqToData(a);if(null!==a){this.xmlInput!==h.Connection.prototype.xmlInput&&(a.nodeName===this._proto.strip&&a.childNodes.length?this.xmlInput(a.childNodes[0]):this.xmlInput(a));for(this.rawInput!==h.Connection.prototype.rawInput&&(b?this.rawInput(b):this.rawInput(h.serialize(a)));0<this.removeHandlers.length;)b=this.removeHandlers.pop(),b=this.handlers.indexOf(b),0<=b&&this.handlers.splice(b,
1);for(;0<this.addHandlers.length;)this.handlers.push(this.addHandlers.pop());this.disconnecting&&this._proto._emptyQueue()?this._doDisconnect():(b=a.getAttribute("type"),null!==b&&"terminate"===b?this.disconnecting||(b=a.getAttribute("condition"),a=a.getElementsByTagName("conflict"),null!==b?("remote-stream-error"===b&&0<a.length&&(b="conflict"),this._changeConnectStatus(h.Status.CONNFAIL,b)):this._changeConnectStatus(h.Status.CONNFAIL,h.ErrorCondition.UNKOWN_REASON),this._doDisconnect(b)):h.forEachChild(a,
null,e=>{const g=[];this.handlers=this.handlers.reduce((l,n)=>{try{!n.isMatch(e)||!this.authenticated&&n.user?l.push(n):(n.run(e)&&l.push(n),g.push(n))}catch(w){h.warn("Removing Strophe handlers due to uncaught exception: "+w.message)}return l},[]);!g.length&&this.iqFallbackHandler.isMatch(e)&&this.iqFallbackHandler.run(e)}))}}_connect_cb(a,b,e){h.debug("_connect_cb was called");this.connected=!0;let g;try{g=this._proto._reqToData(a)}catch(l){if(l.name!==h.ErrorCondition.BAD_FORMAT)throw l;this._changeConnectStatus(h.Status.CONNFAIL,
h.ErrorCondition.BAD_FORMAT);this._doDisconnect(h.ErrorCondition.BAD_FORMAT)}g&&(this.xmlInput!==h.Connection.prototype.xmlInput&&(g.nodeName===this._proto.strip&&g.childNodes.length?this.xmlInput(g.childNodes[0]):this.xmlInput(g)),this.rawInput!==h.Connection.prototype.rawInput&&(e?this.rawInput(e):this.rawInput(h.serialize(g))),this._proto._connect_cb(g)!==h.Status.CONNFAIL&&((g.getElementsByTagNameNS?0<g.getElementsByTagNameNS(h.NS.STREAM,"features").length:0<g.getElementsByTagName("stream:features").length||
0<g.getElementsByTagName("features").length)?(a=Array.from(g.getElementsByTagName("mechanism")).map(l=>this.mechanisms[l.textContent]).filter(l=>l),0===a.length&&0===g.getElementsByTagName("auth").length?this._proto._no_auth_received(b):!1!==this.do_authentication&&this.authenticate(a)):this._proto._no_auth_received(b)))}sortMechanismsByPriority(a){for(let e=0;e<a.length-1;++e){let g=e;for(var b=e+1;b<a.length;++b)a[b].priority>a[g].priority&&(g=b);g!==e&&(b=a[e],a[e]=a[g],a[g]=b)}return a}authenticate(a){this._attemptSASLAuth(a)||
this._attemptLegacyAuth()}_attemptSASLAuth(a){a=this.sortMechanismsByPriority(a||[]);var b=!1;for(let e=0;e<a.length;++e)if(a[e].test(this)){this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=a[e];this._sasl_mechanism.onStart(this);
a=z("auth",{xmlns:h.NS.SASL,mechanism:this._sasl_mechanism.mechname});this._sasl_mechanism.isClientFirst&&(b=this._sasl_mechanism.clientChallenge(this),a.t(Q.btoa(b)));this.send(a.tree());b=!0;break}return b}_sasl_challenge_cb(a){a=Q.atob(h.getText(a));a=this._sasl_mechanism.onChallenge(this,a);const b=z("response",{xmlns:h.NS.SASL});""!==a&&b.t(Q.btoa(a));this.send(b.tree());return!0}_attemptLegacyAuth(){null===h.getNodeFromJid(this.jid)?(this._changeConnectStatus(h.Status.CONNFAIL,h.ErrorCondition.MISSING_JID_NODE),
this.disconnect(h.ErrorCondition.MISSING_JID_NODE)):(this._changeConnectStatus(h.Status.AUTHENTICATING,null),this._addSysHandler(this._onLegacyAuthIQResult.bind(this),null,null,null,"_auth_1"),this.send(F({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:h.NS.AUTH}).c("username",{}).t(h.getNodeFromJid(this.jid)).tree()))}_onLegacyAuthIQResult(a){a=F({type:"set",id:"_auth_2"}).c("query",{xmlns:h.NS.AUTH}).c("username",{}).t(h.getNodeFromJid(this.jid)).up().c("password").t(this.pass);h.getResourceFromJid(this.jid)||
(this.jid=h.getBareJidFromJid(this.jid)+"/strophe");a.up().c("resource",{}).t(h.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(a.tree());return!1}_sasl_success_cb(a){if(this._sasl_data["server-signature"]){let g;a=Q.atob(h.getText(a)).match(/([a-z]+)=([^,]+)(,|$)/);"v"===a[1]&&(g=a[2]);if(g!==this._sasl_data["server-signature"])return this.deleteHandler(this._sasl_failure_handler),this._sasl_failure_handler=null,this._sasl_challenge_handler&&
(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null),this._sasl_data={},this._sasl_failure_cb(null)}h.info("SASL authentication succeeded.");if(this._sasl_mechanism)this._sasl_mechanism.onSuccess();this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);const b=[],e=(g,l)=>{for(;g.length;)this.deleteHandler(g.pop());this._onStreamFeaturesAfterSASL(l);
return!1};b.push(this._addSysHandler(g=>e(b,g),null,"stream:features",null,null));b.push(this._addSysHandler(g=>e(b,g),h.NS.STREAM,"features",null,null));this._sendRestart();return!1}_onStreamFeaturesAfterSASL(a){this.features=a;for(let b=0;b<a.childNodes.length;b++){const e=a.childNodes[b];"bind"===e.nodeName&&(this.do_bind=!0);"session"===e.nodeName&&(this.do_session=!0)}this.do_bind?this.options.explicitResourceBinding?this._changeConnectStatus(h.Status.BINDREQUIRED,null):this.bind():this._changeConnectStatus(h.Status.AUTHFAIL,
null);return!1}bind(){if(this.do_bind){this._addSysHandler(this._onResourceBindResultIQ.bind(this),null,null,null,"_bind_auth_2");var a=h.getResourceFromJid(this.jid);a?this.send(F({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:h.NS.BIND}).c("resource",{}).t(a).tree()):this.send(F({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:h.NS.BIND}).tree())}else h.log(h.LogLevel.INFO,'Strophe.Connection.prototype.bind called but "do_bind" is false')}_onResourceBindResultIQ(a){if("error"===a.getAttribute("type")){h.warn("Resource binding failed.");
if(0<a.getElementsByTagName("conflict").length)var b=h.ErrorCondition.CONFLICT;this._changeConnectStatus(h.Status.AUTHFAIL,b,a);return!1}b=a.getElementsByTagName("bind");if(0<b.length)a=b[0].getElementsByTagName("jid"),0<a.length&&(this.authenticated=!0,this.jid=h.getText(a[0]),this.do_session?this._establishSession():this._changeConnectStatus(h.Status.CONNECTED,null));else return h.warn("Resource binding failed."),this._changeConnectStatus(h.Status.AUTHFAIL,null,a),!1}_establishSession(){if(!this.do_session)throw Error("Strophe.Connection.prototype._establishSession "+
`called but apparently ${h.NS.SESSION} wasn't advertised by the server`);this._addSysHandler(this._onSessionResultIQ.bind(this),null,null,null,"_session_auth_2");this.send(F({type:"set",id:"_session_auth_2"}).c("session",{xmlns:h.NS.SESSION}).tree())}_onSessionResultIQ(a){"result"===a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(h.Status.CONNECTED,null)):"error"===a.getAttribute("type")&&(this.authenticated=!1,h.warn("Session creation failed."),this._changeConnectStatus(h.Status.AUTHFAIL,
null,a));return!1}_sasl_failure_cb(a){this._sasl_success_handler&&(this.deleteHandler(this._sasl_success_handler),this._sasl_success_handler=null);this._sasl_challenge_handler&&(this.deleteHandler(this._sasl_challenge_handler),this._sasl_challenge_handler=null);if(this._sasl_mechanism)this._sasl_mechanism.onFailure();this._changeConnectStatus(h.Status.AUTHFAIL,null,a);return!1}_auth2_cb(a){"result"===a.getAttribute("type")?(this.authenticated=!0,this._changeConnectStatus(h.Status.CONNECTED,null)):
"error"===a.getAttribute("type")&&(this._changeConnectStatus(h.Status.AUTHFAIL,null,a),this.disconnect("authentication failed"));return!1}_addSysTimedHandler(a,b){a=new h.TimedHandler(a,b);a.user=!1;this.addTimeds.push(a);return a}_addSysHandler(a,b,e,g,l){a=new h.Handler(a,b,e,g,l);a.user=!1;this.addHandlers.push(a);return a}_onDisconnectTimeout(){h.debug("_onDisconnectTimeout was called");this._changeConnectStatus(h.Status.CONNTIMEOUT,null);this._proto._onDisconnectTimeout();this._doDisconnect();
return!1}_onIdle(){for(;0<this.addTimeds.length;)this.timedHandlers.push(this.addTimeds.pop());for(;0<this.removeTimeds.length;){var a=this.removeTimeds.pop();a=this.timedHandlers.indexOf(a);0<=a&&this.timedHandlers.splice(a,1)}a=(new Date).getTime();const b=[];for(let e=0;e<this.timedHandlers.length;e++){const g=this.timedHandlers[e];if(this.authenticated||!g.user)0>=g.lastCalled+g.period-a?g.run()&&b.push(g):b.push(g)}this.timedHandlers=b;clearTimeout(this._idleTimeout);this._proto._onIdle();this.connected&&
(this._idleTimeout=setTimeout(()=>this._onIdle(),100))}};h.SASLMechanism=K;h.SASLAnonymous=Z;h.SASLPlain=ca;h.SASLSHA1=da;h.SASLOAuthBearer=ba;h.SASLExternal=aa;h.SASLXOAuth2=ea;h.Request=class{constructor(a,b,e,g){this.id=++h._requestId;this.xmlData=a;this.data=h.serialize(a);this.func=this.origFunc=b;this.rid=e;this.date=NaN;this.sends=g||0;this.abort=!1;this.dead=null;this.age=function(){return this.date?(new Date-this.date)/1E3:0};this.timeDead=function(){return this.dead?(new Date-this.dead)/
1E3:0};this.xhr=this._newXHR()}getResponse(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){if(a=this.xhr.responseXML.documentElement,"parsererror"===a.tagName)throw h.error("invalid response received"),h.error("responseText: "+this.xhr.responseText),h.error("responseXML: "+h.serialize(this.xhr.responseXML)),Error("parsererror");}else if(this.xhr.responseText){h.debug("Got responseText but no responseXML; attempting to parse it with DOMParser...");a=(new H).parseFromString(this.xhr.responseText,
"application/xml").documentElement;if(!a)throw Error("Parsing produced null node");if(a.querySelector("parsererror"))throw h.error("invalid response received: "+a.querySelector("parsererror").textContent),h.error("responseText: "+this.xhr.responseText),a=Error(),a.name=h.ErrorCondition.BAD_FORMAT,a;}return a}_newXHR(){let a=null;window.XMLHttpRequest?(a=new XMLHttpRequest,a.overrideMimeType&&a.overrideMimeType("text/xml; charset=utf-8")):window.ActiveXObject&&(a=new ActiveXObject("Microsoft.XMLHTTP"));
a.onreadystatechange=this.func.bind(null,this);return a}};h.Bosh=class a{constructor(b){this._conn=b;this.rid=Math.floor(4294967295*Math.random());this.sid=null;this.hold=1;this.wait=60;this.window=5;this.errors=0;this.lastResponseHeaders=this.inactivity=null;this._requests=[]}_buildBody(){const b=z("body",{rid:this.rid++,xmlns:h.NS.HTTPBIND});null!==this.sid&&b.attrs({sid:this.sid});this._conn.options.keepalive&&this._conn._sessionCachingSupported()&&this._cacheSession();return b}_reset(){this.rid=
Math.floor(4294967295*Math.random());this.sid=null;this.errors=0;this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");this._conn.nextValidRid(this.rid)}_connect(b,e,g){this.wait=b||this.wait;this.hold=e||this.hold;this.errors=0;b=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":h.NS.BOSH});g&&b.attrs({route:g});g=this._conn._connect_cb;
this._requests.push(new h.Request(b.tree(),this._onRequestStateChange.bind(this,g.bind(this._conn)),b.tree().getAttribute("rid")));this._throttledRequestHandler()}_attach(b,e,g,l,n,w,x){this._conn.jid=b;this.sid=e;this.rid=g;this._conn.connect_callback=l;this._conn.domain=h.getDomainFromJid(this._conn.jid);this._conn.authenticated=!0;this._conn.connected=!0;this.wait=n||this.wait;this.hold=w||this.hold;this.window=x||this.window;this._conn._changeConnectStatus(h.Status.ATTACHED,null)}_restore(b,e,
g,l,n){const w=JSON.parse(window.sessionStorage.getItem("strophe-bosh-session"));if("undefined"!==typeof w&&null!==w&&w.rid&&w.sid&&w.jid&&("undefined"===typeof b||null===b||h.getBareJidFromJid(w.jid)===h.getBareJidFromJid(b)||null===h.getNodeFromJid(b)&&h.getDomainFromJid(w.jid)===b))this._conn.restored=!0,this._attach(w.jid,w.sid,w.rid,e,g,l,n);else throw b=Error("_restore: no restoreable session."),b.name="StropheSessionError",b;}_cacheSession(){this._conn.authenticated?this._conn.jid&&this.rid&&
this.sid&&window.sessionStorage.setItem("strophe-bosh-session",JSON.stringify({jid:this._conn.jid,rid:this.rid,sid:this.sid})):window.sessionStorage.removeItem("strophe-bosh-session")}_connect_cb(b){var e=b.getAttribute("type");if(null!==e&&"terminate"===e)return e=b.getAttribute("condition"),h.error("BOSH-Connection failed: "+e),b=b.getElementsByTagName("conflict"),null!==e?("remote-stream-error"===e&&0<b.length&&(e="conflict"),this._conn._changeConnectStatus(h.Status.CONNFAIL,e)):this._conn._changeConnectStatus(h.Status.CONNFAIL,
"unknown"),this._conn._doDisconnect(e),h.Status.CONNFAIL;this.sid||(this.sid=b.getAttribute("sid"));if(e=b.getAttribute("requests"))this.window=parseInt(e,10);if(e=b.getAttribute("hold"))this.hold=parseInt(e,10);if(e=b.getAttribute("wait"))this.wait=parseInt(e,10);if(b=b.getAttribute("inactivity"))this.inactivity=parseInt(b,10)}_disconnect(b){this._sendTerminate(b)}_doDisconnect(){this.sid=null;this.rid=Math.floor(4294967295*Math.random());this._conn._sessionCachingSupported()&&window.sessionStorage.removeItem("strophe-bosh-session");
this._conn.nextValidRid(this.rid)}_emptyQueue(){return 0===this._requests.length}_callProtocolErrorHandlers(b){b=a._getRequestStatus(b);const e=this._conn.protocolErrorHandlers.HTTP[b];e&&e.call(this,b)}_hitError(b){this.errors++;h.warn("request errored, status: "+b+", number of errors: "+this.errors);4<this.errors&&this._conn._onDisconnectTimeout()}_no_auth_received(b){h.warn("Server did not yet offer a supported authentication mechanism. Sending a blank poll request.");b=b?b.bind(this._conn):this._conn._connect_cb.bind(this._conn);
const e=this._buildBody();this._requests.push(new h.Request(e.tree(),this._onRequestStateChange.bind(this,b),e.tree().getAttribute("rid")));this._throttledRequestHandler()}_onDisconnectTimeout(){this._abortAllRequests()}_abortAllRequests(){for(;0<this._requests.length;){const b=this._requests.pop();b.abort=!0;b.xhr.abort();b.xhr.onreadystatechange=function(){}}}_onIdle(){var b=this._conn._data;this._conn.authenticated&&0===this._requests.length&&0===b.length&&!this._conn.disconnecting&&(h.debug("no requests during idle cycle, sending blank request"),
b.push(null));if(!this._conn.paused){if(2>this._requests.length&&0<b.length){const e=this._buildBody();for(let g=0;g<b.length;g++)null!==b[g]&&("restart"===b[g]?e.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":h.NS.BOSH}):e.cnode(b[g]).up());delete this._conn._data;this._conn._data=[];this._requests.push(new h.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid")));this._throttledRequestHandler()}0<
this._requests.length&&(b=this._requests[0].age(),null!==this._requests[0].dead&&this._requests[0].timeDead()>Math.floor(h.SECONDARY_TIMEOUT*this.wait)&&this._throttledRequestHandler(),b>Math.floor(h.TIMEOUT*this.wait)&&(h.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(h.TIMEOUT*this.wait)+" seconds since last activity"),this._throttledRequestHandler()))}}static _getRequestStatus(b,e){let g;if(4===b.xhr.readyState)try{g=b.xhr.status}catch(l){h.error("Caught an error while retrieving a request's status, reqStatus: "+
g)}"undefined"===typeof g&&(g="number"===typeof e?e:0);return g}_onRequestStateChange(b,e){h.debug("request id "+e.id+"."+e.sends+" state changed to "+e.xhr.readyState);if(e.abort)e.abort=!1;else if(4===e.xhr.readyState){var g=a._getRequestStatus(e);this.lastResponseHeaders=e.xhr.getAllResponseHeaders();if(this._conn.disconnecting&&400<=g)this._hitError(g),this._callProtocolErrorHandlers(e);else{var l=this._requests[0]===e,n=this._requests[1]===e,w=0<g&&500>g,x=e.sends>this._conn.maxRetries;if(w||
x)this._removeRequest(e),h.debug("request id "+e.id+" should now be removed");200===g?((n||l&&0<this._requests.length&&this._requests[0].age()>Math.floor(h.SECONDARY_TIMEOUT*this.wait))&&this._restartRequest(0),this._conn.nextValidRid(Number(e.rid)+1),h.debug("request id "+e.id+"."+e.sends+" got 200"),b(e),this.errors=0):0===g||400<=g&&600>g||12E3<=g?(h.error("request id "+e.id+"."+e.sends+" error "+g+" happened"),this._hitError(g),this._callProtocolErrorHandlers(e),400<=g&&500>g&&(this._conn._changeConnectStatus(h.Status.DISCONNECTING,
null),this._conn._doDisconnect())):h.error("request id "+e.id+"."+e.sends+" error "+g+" happened");w||x?x&&!this._conn.connected&&this._conn._changeConnectStatus(h.Status.CONNFAIL,"giving-up"):this._throttledRequestHandler()}}}_processRequest(b){let e=this._requests[b];var g=a._getRequestStatus(e,-1);if(e.sends>this._conn.maxRetries)this._conn._onDisconnectTimeout();else{var l=e.age();l=!isNaN(l)&&l>Math.floor(h.TIMEOUT*this.wait);var n=null!==e.dead&&e.timeDead()>Math.floor(h.SECONDARY_TIMEOUT*this.wait);
g=4===e.xhr.readyState&&(1>g||500<=g);if(l||n||g)n&&h.error(`Request ${this._requests[b].id} timed out (secondary), restarting`),e.abort=!0,e.xhr.abort(),e.xhr.onreadystatechange=function(){},this._requests[b]=new h.Request(e.xmlData,e.origFunc,e.rid,e.sends),e=this._requests[b];if(0===e.xhr.readyState){h.debug("request id "+e.id+"."+e.sends+" posting");try{const x=this._conn.options.contentType||"text/xml; charset=utf-8";e.xhr.open("POST",this._conn.service,this._conn.options.sync?!1:!0);"undefined"!==
typeof e.xhr.setRequestHeader&&e.xhr.setRequestHeader("Content-Type",x);this._conn.options.withCredentials&&(e.xhr.withCredentials=!0)}catch(x){h.error("XHR open failed: "+x.toString());this._conn.connected||this._conn._changeConnectStatus(h.Status.CONNFAIL,"bad-service");this._conn.disconnect();return}const w=()=>{e.date=new Date;if(this._conn.options.customHeaders){const x=this._conn.options.customHeaders;for(const y in x)Object.prototype.hasOwnProperty.call(x,y)&&e.xhr.setRequestHeader(y,x[y])}e.xhr.send(e.data)};
1<e.sends?setTimeout(function(){w()},1E3*Math.min(Math.floor(h.TIMEOUT*this.wait),Math.pow(e.sends,3))):w();e.sends++;this._conn.xmlOutput!==h.Connection.prototype.xmlOutput&&(e.xmlData.nodeName===this.strip&&e.xmlData.childNodes.length?this._conn.xmlOutput(e.xmlData.childNodes[0]):this._conn.xmlOutput(e.xmlData));this._conn.rawOutput!==h.Connection.prototype.rawOutput&&this._conn.rawOutput(e.data)}else h.debug("_processRequest: "+(0===b?"first":"second")+" request has readyState of "+e.xhr.readyState)}}_removeRequest(b){h.debug("removing request");
for(let e=this._requests.length-1;0<=e;e--)b===this._requests[e]&&this._requests.splice(e,1);b.xhr.onreadystatechange=function(){};this._throttledRequestHandler()}_restartRequest(b){const e=this._requests[b];null===e.dead&&(e.dead=new Date);this._processRequest(b)}_reqToData(b){try{return b.getResponse()}catch(e){if("parsererror"!==e.message)throw e;this._conn.disconnect("strophe-parsererror")}}_sendTerminate(b){h.debug("_sendTerminate was called");const e=this._buildBody().attrs({type:"terminate"});
b&&e.cnode(b.tree());b=new h.Request(e.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),e.tree().getAttribute("rid"));this._requests.push(b);this._throttledRequestHandler()}_send(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(()=>this._conn._onIdle(),100)}_sendRestart(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout)}_throttledRequestHandler(){this._requests?h.debug("_throttledRequestHandler called with "+
this._requests.length+" requests"):h.debug("_throttledRequestHandler called with undefined requests");this._requests&&0!==this._requests.length&&(0<this._requests.length&&this._processRequest(0),1<this._requests.length&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window&&this._processRequest(1))}};h.Bosh.prototype.strip=null;h.Websocket=class{constructor(a){this._conn=a;this.strip="wrapper";const b=a.service;if(0!==b.indexOf("ws:")&&0!==b.indexOf("wss:")){let e="";e="ws"===a.options.protocol&&
"https:"!==window.location.protocol?e+"ws":e+"wss";e+="://"+window.location.host;e=0!==b.indexOf("/")?e+(window.location.pathname+b):e+b;a.service=e}}_buildStream(){return z("open",{xmlns:h.NS.FRAMING,to:this._conn.domain,version:"1.0"})}_checkStreamError(a,b){a=a.getElementsByTagNameNS?a.getElementsByTagNameNS(h.NS.STREAM,"error"):a.getElementsByTagName("stream:error");if(0===a.length)return!1;var e=a[0];let g=a="";for(let l=0;l<e.childNodes.length;l++){const n=e.childNodes[l];if("urn:ietf:params:xml:ns:xmpp-streams"!==
n.getAttribute("xmlns"))break;"text"===n.nodeName?g=n.textContent:a=n.nodeName}e="WebSocket stream error: ";e=a?e+a:e+"unknown";g&&(e+=" - "+g);h.error(e);this._conn._changeConnectStatus(b,a);this._conn._doDisconnect();return!0}_reset(){}_connect(){this._closeSocket();this.socket=new S(this._conn.service,"xmpp");this.socket.onopen=()=>this._onOpen();this.socket.onerror=a=>this._onError(a);this.socket.onclose=a=>this._onClose(a);this.socket.onmessage=a=>this._onInitialMessage(a)}_connect_cb(a){if(this._checkStreamError(a,
h.Status.CONNFAIL))return h.Status.CONNFAIL}_handleStreamStart(a){let b=!1;const e=a.getAttribute("xmlns");"string"!==typeof e?b="Missing xmlns in <open />":e!==h.NS.FRAMING&&(b="Wrong xmlns in <open />: "+e);a=a.getAttribute("version");"string"!==typeof a?b="Missing version in <open />":"1.0"!==a&&(b="Wrong version in <open />: "+a);return b?(this._conn._changeConnectStatus(h.Status.CONNFAIL,b),this._conn._doDisconnect(),!1):!0}_onInitialMessage(a){if(0===a.data.indexOf("<open ")||0===a.data.indexOf("<?xml")){var b=
a.data.replace(/^(<\?.*?\?>\s*)*/,"");""!==b&&(b=(new H).parseFromString(b,"text/xml").documentElement,this._conn.xmlInput(b),this._conn.rawInput(a.data),this._handleStreamStart(b)&&this._connect_cb(b))}else if(0===a.data.indexOf("<close "))if(b=(new H).parseFromString(a.data,"text/xml").documentElement,this._conn.xmlInput(b),this._conn.rawInput(a.data),a=b.getAttribute("see-other-uri")){if(b=this._conn.service,0<=b.indexOf("wss:")&&0<=a.indexOf("wss:")||0<=b.indexOf("ws:"))this._conn._changeConnectStatus(h.Status.REDIRECT,
"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=a,this._connect()}else this._conn._changeConnectStatus(h.Status.CONNFAIL,"Received closing stream"),this._conn._doDisconnect();else this._replaceMessageHandler(),b=this._streamWrap(a.data),b=(new H).parseFromString(b,"text/xml").documentElement,this._conn._connect_cb(b,null,a.data)}_replaceMessageHandler(){this.socket.onmessage=a=>this._onMessage(a)}_disconnect(a){if(this.socket&&this.socket.readyState!==S.CLOSED){a&&
this._conn.send(a);a=z("close",{xmlns:h.NS.FRAMING});this._conn.xmlOutput(a.tree());a=h.serialize(a);this._conn.rawOutput(a);try{this.socket.send(a)}catch(b){h.warn("Couldn't send <close /> tag.")}}setTimeout(()=>this._conn._doDisconnect,0)}_doDisconnect(){h.debug("WebSockets _doDisconnect was called");this._closeSocket()}_streamWrap(a){return"<wrapper>"+a+"</wrapper>"}_closeSocket(){if(this.socket)try{this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null,this.socket.close()}catch(a){h.debug(a.message)}this.socket=
null}_emptyQueue(){return!0}_onClose(a){this._conn.connected&&!this._conn.disconnecting?(h.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):a&&1006===a.code&&!this._conn.connected&&this.socket?(h.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(h.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):h.debug("Websocket closed")}_no_auth_received(a){h.error("Server did not offer a supported authentication mechanism");
this._conn._changeConnectStatus(h.Status.CONNFAIL,h.ErrorCondition.NO_AUTH_MECH);a&&a.call(this._conn);this._conn._doDisconnect()}_onDisconnectTimeout(){}_abortAllRequests(){}_onError(a){h.error("Websocket error "+JSON.stringify(a));this._conn._changeConnectStatus(h.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected.");this._disconnect()}_onIdle(){const a=this._conn._data;if(0<a.length&&!this._conn.paused){for(let b=0;b<a.length;b++)if(null!==a[b]){let e;e="restart"===
a[b]?this._buildStream().tree():a[b];const g=h.serialize(e);this._conn.xmlOutput(e);this._conn.rawOutput(g);this.socket.send(g)}this._conn._data=[]}}_onMessage(a){if('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'===a.data)this._conn.rawInput('<close xmlns="urn:ietf:params:xml:ns:xmpp-framing" />'),this._conn.xmlInput(a),this._conn.disconnecting||this._conn._doDisconnect();else{if(0===a.data.search("<open ")){var b=(new H).parseFromString(a.data,"text/xml").documentElement;if(!this._handleStreamStart(b))return}else b=
this._streamWrap(a.data),b=(new H).parseFromString(b,"text/xml").documentElement;this._checkStreamError(b,h.Status.ERROR)||(this._conn.disconnecting&&"presence"===b.firstChild.nodeName&&"unavailable"===b.firstChild.getAttribute("type")?(this._conn.xmlInput(b),this._conn.rawInput(h.serialize(b))):this._conn._dataRecv(b,a.data))}}_onOpen(){h.debug("Websocket open");var a=this._buildStream();this._conn.xmlOutput(a.tree());a=h.serialize(a);this._conn.rawOutput(a);this.socket.send(a)}_reqToData(a){return a}_send(){this._conn.flush()}_sendRestart(){clearTimeout(this._conn._idleTimeout);
this._conn._onIdle.bind(this._conn)()}};const N={};N.debug=h.LogLevel.DEBUG;N.info=h.LogLevel.INFO;N.warn=h.LogLevel.WARN;N.error=h.LogLevel.ERROR;N.fatal=h.LogLevel.FATAL;h.WorkerWebsocket=class extends h.Websocket{constructor(a){super(a);this._conn=a;this.worker=new SharedWorker(this._conn.options.worker,"Strophe XMPP Connection");this.worker.onerror=b=>{var e;null===(e=console)||void 0===e?void 0:e.error(b);h.log(h.LogLevel.ERROR,`Shared Worker Error: ${b}`)}}get socket(){return{send:a=>this.worker.port.postMessage(["send",
a])}}_connect(){this._messageHandler=a=>this._onInitialMessage(a);this.worker.port.start();this.worker.port.onmessage=a=>this._onWorkerMessage(a);this.worker.port.postMessage(["_connect",this._conn.service,this._conn.jid])}_attach(a){this._messageHandler=b=>this._onMessage(b);this._conn.connect_callback=a;this.worker.port.start();this.worker.port.onmessage=b=>this._onWorkerMessage(b);this.worker.port.postMessage(["_attach",this._conn.service])}_attachCallback(a,b){a===h.Status.ATTACHED?(this._conn.jid=
b,this._conn.authenticated=!0,this._conn.connected=!0,this._conn.restored=!0,this._conn._changeConnectStatus(h.Status.ATTACHED)):a===h.Status.ATTACHFAIL&&(this._conn.authenticated=!1,this._conn.connected=!1,this._conn.restored=!1,this._conn._changeConnectStatus(h.Status.ATTACHFAIL))}_disconnect(a,b){b&&this._conn.send(b);a=z("close",{xmlns:h.NS.FRAMING});this._conn.xmlOutput(a.tree());a=h.serialize(a);this._conn.rawOutput(a);this.worker.port.postMessage(["send",a]);this._conn._doDisconnect()}_onClose(a){this._conn.connected&&
!this._conn.disconnecting?(h.error("Websocket closed unexpectedly"),this._conn._doDisconnect()):a&&1006===a.code&&!this._conn.connected?(h.error("Websocket closed unexcectedly"),this._conn._changeConnectStatus(h.Status.CONNFAIL,"The WebSocket connection could not be established or was disconnected."),this._conn._doDisconnect()):h.debug("Websocket closed")}_closeSocket(){this.worker.port.postMessage(["_closeSocket"])}_replaceMessageHandler(){this._messageHandler=a=>this._onMessage(a)}_onWorkerMessage(a){const {data:b}=
a,e=b[0];if("_onMessage"===e)this._messageHandler(b[1]);else if(e in this)try{this[e].apply(this,a.data.slice(1))}catch(g){h.log(h.LogLevel.ERROR,g)}else"log"===e?h.log(N[b[1]],b[2]):h.log(h.LogLevel.ERROR,`Found unhandled service worker message: ${b}`)}};J.$build=z;J.$iq=F;J.$msg=O;J.$pres=G;J.Strophe=h;const {b64_sha1:fa}=E;d.$build=z;d.$iq=F;d.$msg=O;d.$pres=G;d.Strophe=h;d.b64_sha1=fa;Object.defineProperty(d,"__esModule",{value:!0})});Strophe.addConnectionPlugin("disco",{_connection:null,_identities:[],_features:[],_items:[],init:function(d){this._connection=d;this._identities=[];this._features=[];this._items=[];d.addHandler(this._onDiscoInfo.bind(this),Strophe.NS.DISCO_INFO,"iq","get",null,null);d.addHandler(this._onDiscoItems.bind(this),Strophe.NS.DISCO_ITEMS,"iq","get",null,null)},addIdentity:function(d,f,k,m){for(var p=0;p<this._identities.length;p++)if(this._identities[p].category==d&&this._identities[p].type==f&&this._identities[p].name==
k&&this._identities[p].lang==m)return!1;this._identities.push({category:d,type:f,name:k,lang:m});return!0},addFeature:function(d){for(var f=0;f<this._features.length;f++)if(this._features[f]==d)return!1;this._features.push(d);return!0},addItem:function(d,f,k,m){if(k&&!m)return!1;this._items.push({jid:d,name:f,node:k,call_back:m});return!0},info:function(d,f,k,m){var p={xmlns:Strophe.NS.DISCO_INFO};f&&(p.node=f);d=$iq({from:this._connection.jid,to:d,type:"get"}).c("query",p);this._connection.sendIQ(d,
k,m)},items:function(d,f,k,m){var p={xmlns:Strophe.NS.DISCO_ITEMS};f&&(p.node=f);d=$iq({from:this._connection.jid,to:d,type:"get"}).c("query",p);this._connection.sendIQ(d,k,m)},_onDiscoInfo:function(d){var f=d.getAttribute("id"),k=d.getAttribute("from"),m=d.getElementsByTagName("query")[0].getAttribute("node");d={xmlns:Strophe.NS.DISCO_INFO};m&&(d.node=m);f=$iq({type:"result",id:f,to:k}).c("query",d);for(k=0;k<this._identities.length;k++)d={category:this._identities[k].category,type:this._identities[k].type},
this._identities[k].name&&(d.name=this._identities[k].name),this._identities[k].lang&&(d["xml:lang"]=this._identities[k].lang),f.c("identity",d).up();for(k=0;k<this._features.length;k++)f.c("feature",{"var":this._features[k]}).up();this._connection.send(f.tree())},_onDiscoItems:function(d){var f=d.getAttribute("id"),k=d.getAttribute("from"),m={xmlns:Strophe.NS.DISCO_ITEMS},p=d.getElementsByTagName("query")[0].getAttribute("node");if(p){m.node=p;for(var q=null,u=0;u<this._items.length;u++)if(this._items[u].node==
p){q=this._items[u].call_back(d);break}}else q=this._items;d=$iq({type:"result",id:f,to:k}).c("query",m);for(u=0;u<q.length;u++)f={jid:q[u].jid},q[u].name&&(f.name=q[u].name),q[u].node&&(f.node=q[u].node),d.c("item",f).up();this._connection.send(d.tree())}});Ext.ns("Application");
Application.LoginPanel=Ext.extend(Ext.Panel,{initComponent:function(){this.items=[{html:'<img src="images/nws.png" width="100"/>',height:105,width:105},{xtype:"panel",autoShow:!0,el:"myloginform",layout:"form",id:"myform",width:276,labelWidth:76,defaultType:"textfield",defaults:{allowBlank:!1},items:[{anchor:"100%",el:"username",id:"username",autoShow:!0,fieldLabel:"Username"},{anchor:"100%",el:"password",id:"password",autoShow:!0,fieldLabel:"Password",listeners:{specialkey:function(d,f){f.getKey()===
f.ENTER&&(Application.doLogin(),f.stopEvent())}}}],buttons:[{text:"Show Debug",handler:function(){Ext.getCmp("debug").show()}},{text:"Browser Save Login",handler:function(d,f){Ext.get("submit").dom.click()}},{text:"Login",handler:Application.doLogin}]},{xtype:"panel",colspan:2,contentEl:"loginmessage",preventBodyReset:!0}];Ext.apply(this,Ext.apply(this.initialConfig,{autoScroll:!0,title:"Login with Account",layout:"table",layoutConfig:{columns:2}}));Application.LoginPanel.superclass.initComponent.apply(this,
arguments)},addMessage:function(d){Application.msgtpl.insertFirst(this.items.items[2].body,{msg:d,date:new Date})}});Ext.namespace("Application");
Application.TabLoginPanel=Ext.extend(Ext.TabPanel,{initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{width:420,height:250,autoScroll:!0}));Application.TabLoginPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){Application.LOGIN_OPT_USER&&this.add(new Application.LoginPanel({id:"loginpanel"}));Application.LOGIN_OPT_ANONYMOUS&&this.add({xtype:"panel",contentEl:"anonymous_div",preventBodyReset:!0,title:"Anonymous Login"});Application.LOGIN_OPT_REGISTER&&
this.add({xtype:"panel",contentEl:"register_div",preventBodyReset:!0,title:"Register Account"});this.activate(0)}});Ext.reg("tabloginpanel",Application.TabLoginPanel);Ext.ns("Application");
Application.DebugWindow=Ext.extend(Ext.Window,{initComponent:function(){this.items=[{xtype:"panel",title:"Debug Log",html:"<p>Browser CodeName: "+navigator.appCodeName+"</p><p>Browser Name: "+navigator.appName+"</p><p>Browser Version: "+navigator.appVersion+"</p><p>Cookies Enabled: "+navigator.cookieEnabled+"</p><p>Platform: "+navigator.platform+"</p><p>User-agent header: "+navigator.userAgent+"</p>",autoScroll:!0}];this.tbar=[{text:"Click to send this log to developer!",icon:"icons/print.png",scope:this,
handler:function(){Ext.Ajax.request({url:"bug.php",method:"POST",success:function(d){alert(d.responseText)},failure:function(){},headers:{"my-header":"foo"},params:{data:this.items.items[0].body.dom.innerHTML,user:Application.USERNAME}})}},{text:"Clear Log",icon:"icons/close.png",handler:function(){this.items.items[0].update("")},scope:this}];Ext.apply(this,Ext.apply(this.initialConfig,{width:600,height:300,title:"Debug Window",closeAction:"hide",hidden:!0,autoScroll:!0,layout:"fit"}));Application.DebugWindow.superclass.initComponent.apply(this,
arguments)},addMessage:function(d){Application.msgtpl.append(this.items.items[0].body,{msg:d,date:new Date})}});Ext.ns("Application");
Application.MUCChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",chatType:"groupchat",barejid:null,handle:null,anonymous:null,joinedChat:!1,initComponent:function(){this.items=[{xtype:"chatgridpanel",region:"center"},{xtype:"chattextentry",region:"south",height:50,split:!0}];"allchats"!=this.initialConfig.chatType?(this.items.push({xtype:"mucroomusers",region:"east",width:175,collapsible:!0,split:!0}),this.iconCls="tabno"):this.items[1].emptyText="Type message here";Ext.apply(this,
Ext.apply(this.initialConfig,{listeners:{activate:function(d){d.iconCls&&d.setIconCls("tabno")},deactivate:function(d){d.iconCls&&d.setIconCls("tabno")}}}));Application.MUCChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},clearRoom:function(){this.gp.getStore().removeAll();this.roomusers.root.removeAll()},getJidByHandle:function(d){d=this.roomusers.root.findChild("text",d);return null==d||Strophe.getDomainFromJid(d.attributes.jid)==Application.XMPPMUCHOST?null:d.attributes.jid},
buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];if("allchats"==this.chatType)this.gp.toolbars[0].items.items[4].disable(),this.gp.soundOn=!1,this.te.items.items[1].setText("To Room?");else{this.roomusers=this.items.items[2];new Ext.tree.TreeSorter(this.roomusers,{folderSort:!0,dir:"asc",property:"text"});this.anonymous&&this.te.disable();var d="muc::"+Strophe.getNodeFromJid(this.barejid)+"::mute";Application.getPreference(d,!1)&&(this.gp.toolbars[0].items.items[4].toggle(!0,
!0),this.gp.toolbars[0].items.items[4].setText("Sounds Muted"),this.gp.soundOn=!1);d="muc::"+Strophe.getNodeFromJid(this.barejid)+"::iembothidden";Application.getPreference(d,!1)&&(this.gp.toolbars[0].items.items[3].toggle(!0,!0),this.gp.toolbars[0].items.items[3].setText("IEMBot Hidden"),this.gp.store.filterBy(iembotFilter))}}});Ext.reg("mucchatpanel",Application.MUCChatPanel);Ext.ns("Application");
Application.MUCRoomUsers=Ext.extend(Ext.tree.TreePanel,{bodyStyle:{"margin-left":"-15px"},title:"0 people in room",rootVisible:!1,lines:!1,autoScroll:!0,initComponent:function(){this.root={text:"test",listeners:{append:function(f,k){sz=k.childNodes.length;f.setTitle(sz+" people in room")},remove:function(f,k){sz=k.childNodes.length;f.setTitle(sz+" people in room")}}};var d={plugins:new Ext.ux.DataTip({tpl:"<div>JID: {jid}<br />Affiliation: {affiliation}<br />Role: {role}</div>",constrainPosition:!0}),
listeners:{click:function(f){if(f.attributes.jid&&(username=Strophe.getNodeFromJid(f.attributes.jid),username!=Application.USERNAME)){var k=f.attributes.jid;Strophe.getDomainFromJid(f.attributes.jid)==Application.XMPPHOST&&(k=Strophe.getBareJidFromJid(f.attributes.jid));Application.log("Wish to start chat with:"+k);(cp=Ext.getCmp("chatpanel").getChat(k))||(cp=Ext.getCmp("chatpanel").addChat(k));Ext.getCmp("chatpanel").setActiveTab(cp)}}}};Ext.apply(this,Ext.apply(this.initialConfig,d));Application.MUCRoomUsers.superclass.initComponent.apply(this,
arguments);this.buildItems()},buildItems:function(){}});Ext.reg("mucroomusers",Application.MUCRoomUsers);Ext.ns("Application");Application.colors="000000 666666 D51460 FF0000 993333 FF9900 005500 009900 00DD00 0066CC 3399FF 0000FF 6666FF".split(" ");Application.colorpointer=0;Application.UserColorStore=new Ext.data.Store({fields:["user","color"]});
Application.getUserColor=function(d){idx=Application.UserColorStore.find("user",d);-1==idx?(c=Application.colors[Application.colorpointer],Application.UserColorStore.add(new Ext.data.Record({user:d,color:c})),Application.colorpointer++,12<Application.colorpointer&&(Application.colorpointer=0)):c=Application.UserColorStore.getAt(idx).get("color");return c};Ext.ns("Application");
Application.msgFormatter=new Ext.XTemplate('<p class="mymessage">',"<span ",'<tpl if="values.me == values.author">','class="author-me"',"</tpl>",'<tpl if="values.me != values.author">','class="{[this.getAuthorClass(values.jid)]}" style="color: #{[Application.getUserColor(values.author)]};"',"</tpl>",">(",'<tpl if="this.isNotToday(ts)">','{ts:date("d M")} ',"</tpl>",'{ts:date("g:i A")}) ','<tpl if="values.room != null">',"[{room}] ","</tpl>","{author}:</span> ","{message}</p>",{isNotToday:function(d){return(new Date).format("md")!=
d.format("md")},getAuthorClass:function(d){return null==d?"author-default":"iembot"==Strophe.getNodeFromJid(d)?"author-iembot":Strophe.getNodeFromJid(d).match(/^nws/)?"author-nws":"author-chatpartner"}});
Application.ChatGridPanel=Ext.extend(Ext.grid.GridPanel,{region:"center",soundOn:!0,iembotHide:!1,stripeRows:!0,autoExpandColumn:"message",autoScroll:!0,tbar:[{text:"Clear Room Log",cls:"x-btn-text-icon",icon:"icons/close.png",handler:function(d,f){d.ownerCt.ownerCt.getStore().removeAll()}},{text:"Print Log",icon:"icons/print.png",cls:"x-btn-text-icon",handler:function(d,f){d.ownerCt.ownerCt.getGridEl().print({isGrid:!0})}},{text:"View As HTML",handler:function(d,f){showHtmlVersion(d.ownerCt.ownerCt)},
icon:"icons/text.png",cls:"x-btn-text-icon"},{text:"Hide IEMBot",enableToggle:!0,toggleHandler:function(d,f){var k="muc::"+Strophe.getNodeFromJid(d.ownerCt.ownerCt.ownerCt.barejid)+"::iembothidden",m=d.ownerCt.ownerCt.getStore();(d.ownerCt.ownerCt.iembotHide=f)?(Application.setPreference(k,"true"),m.filterBy(iembotFilter),d.setText("IEMBot Hidden")):(Application.removePreference(k),m.clearFilter(!1),d.setText("Hide IEMBot"))}},{text:"Mute Sounds",enableToggle:!0,toggleHandler:function(d,f){var k=
"muc::"+Strophe.getNodeFromJid(d.ownerCt.ownerCt.ownerCt.barejid)+"::mute";f?(Application.setPreference(k,"true"),d.ownerCt.ownerCt.soundOn=!1,d.setText("Sounds Muted")):(Application.removePreference(k),d.ownerCt.ownerCt.soundOn=!0,d.setText("Mute Sounds"))}},{icon:"icons/font-less.png",handler:function(){var d=parseInt(Application.getPreference("font-size",14))-2;Application.setPreference("font-size",d);cssfmt=String.format("normal {0}px arial",d);Ext.util.CSS.updateRule("td.x-grid3-td-message",
"font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}},{icon:"icons/font-more.png",handler:function(){var d=parseInt(Application.getPreference("font-size",14))+2;Application.setPreference("font-size",d);cssfmt=String.format("normal {0}px arial",d);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt)}}],initComponent:function(){this.columns=[{header:"Author",sortable:!0,dataIndex:"author",hidden:!0},{id:"message",
header:"Message",sortable:!0,dataIndex:"ts",scope:this,renderer:function(f,k,m){return Application.msgFormatter.apply({author:m.get("author"),message:m.get("message"),ts:m.get("ts"),room:m.get("room"),jid:m.get("jid"),me:this.ownerCt.handle})}}];this.store=new Ext.data.ArrayStore({sortInfo:{field:"ts",direction:"ASC"},fields:[{name:"ts",type:"date"},"author","message","product_id","jid","room",{name:"xdelay",type:"boolean"}]});this.store.on("add",function(f,k,m){if(!this.soundOn)return!0;f=!1;m=!0;
for(var p=0;p<k.length;p++)k[p].get("xdelay")||k[p].get("author")==this.ownerCt.handle||("iembot"!=k[p].get("author")&&(f=!0),k[p].get("message").match(/tornado/i)&&Application.MsgBus.fireEvent("soundevent","tornado"),k[p].get("message").match(this.ownerCt.handle)&&Application.MsgBus.fireEvent("soundevent","myhandle"),m=!1);if(m)return!0;f?(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent","new_message")):this.iembotHide||(this.ownerCt.setIconCls("new-tab"),Application.MsgBus.fireEvent("soundevent",
"iembot"))},this);var d={viewConfig:{onAdd:function(f,k,m){this.constructor.prototype.onAdd.apply(this,arguments);(row=this.grid.getView().getRow(m))&&row.scrollIntoView()},templates:{cell:new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} x-selectable {css}" style="{style}"  tabIndex="0" {cellAttr}>','<div class="x-grid3-cell-inner x-grid3-col-{id}" {attr}>{value}</div>',"</td>")}},sm:new Ext.grid.RowSelectionModel({listeners:{rowselect:function(f,k,m){m.data.product_id&&(Application.TextWindow.show(),
Application.TextWindow.load({params:{pid:m.data.product_id,bypass:1},text:"Loading...",method:"GET",url:"../p.php"}))}}}),listeners:{render:function(f){f.getView().mainBody.on("mousedown",function(k,m){"A"==m.tagName&&(k.stopEvent(),m.target="_blank")});f.body.on({mousedown:function(k,m){m.target="_blank";Application.TextWindow.hide()},click:function(k,m){"_blank"!=String(m.target).toLowerCase()&&(k.stopEvent(),window.open(m.href));Application.TextWindow.hide()},delegate:"a"})}}};Ext.apply(this,d);
Application.ChatGridPanel.superclass.initComponent.apply(this,arguments)}});Ext.reg("chatgridpanel",Application.ChatGridPanel);Ext.ns("Application");
Application.ChatTextEntry=Ext.extend(Ext.Panel,{layout:"hbox",layoutConfig:{align:"stretch"},border:!1,chatstate:null,initComponent:function(){this.items=[{xtype:"textarea",flex:1,cls:"message-entry-box",autoCreate:{tag:"textarea",style:'rows:10;cols:72;wrap:"hard";',autocomplete:"off"},style:{background:"#"+Application.getPreference("bgcolor","FFFFFF"),color:"#"+Application.getPreference("fgcolor","000000")},enableKeyEvents:!0,listeners:{keyup:function(d,f){if(f.getKey()===f.ENTER&&!f.shiftKey)return this.chatstate&&
this.chatstate.cancel(),this.chatstate=null,this.ownerCt.getComponent(1).handler(),!0;"chat"==this.ownerCt.ownerCt.chatType&&(this.chatstate||(this.chatstate=new Ext.util.DelayedTask(function(){this.ownerCt&&this.ownerCt.ownerCt&&(Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("paused",{xmlns:"http://jabber.org/protocol/chatstates"})),this.chatstate=null)},this),Application.XMPPConn.send($msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("composing",
{xmlns:"http://jabber.org/protocol/chatstates"}))),this.chatstate.delay(5E3))},render:{delay:500,fn:function(){this.focus()}}}},{xtype:"button",text:"Send",width:60,popup:null,handler:function(){var d=this.ownerCt.getComponent(0),f=d.getValue().trim();if(0===f.length)return d.focus(),!1;var k=Application.getPreference("bgcolor","FFFFFF"),m=Application.getPreference("fgcolor","000000");if("allchats"==this.ownerCt.ownerCt.chatType)d.emptyText="",d.setValue(""),(new Application.AllChatMessageWindow({message:Application.replaceURLWithHTMLLinks(f)})).show();
else{for(var p=$.parseHTML(Application.replaceURLWithHTMLLinks(f)),q=$msg({to:this.ownerCt.ownerCt.barejid,type:this.ownerCt.ownerCt.chatType}).c("active",{xmlns:"http://jabber.org/protocol/chatstates"}).up().c("body").t(f).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+m+";background:#"+k+";"}),u=0;u<p.length;u++)q=q.cnode(p[u]),u<p.length&&(q=q.up());Application.XMPPConn.send(q);d.setValue("");d.focus();
"chat"==this.ownerCt.ownerCt.chatType&&(f="<span style='color:#"+m+";background:#"+k+";'>"+f+"</span>",this.ownerCt.ownerCt.gp.getStore().addSorted(new Ext.data.Record({ts:new Date,author:Application.USERNAME,message:Application.replaceURLWithHTMLLinks(f)})))}}}];Application.ChatTextEntry.superclass.initComponent.apply(this,arguments)}});Ext.reg("chattextentry",Application.ChatTextEntry);Ext.ns("Application");
Application.ChatPanel=Ext.extend(Ext.Panel,{hideMode:"offsets",closable:!0,layout:"border",iconCls:"tabno",chatType:"chat",barejid:null,handle:null,anonymous:null,initComponent:function(){this.items=[new Application.ChatGridPanel({region:"center"}),new Application.ChatTextEntry({region:"south",height:50,split:!0})];Ext.apply(this,Ext.apply(this.initialConfig,{listeners:{activate:function(d){d.setIconCls("tabno")},deactivate:function(d){d.setIconCls("tabno")},beforedestroy:function(d){d.te.chatstate&&d.te.chatstate.cancel();
Application.XMPPConn.send($msg({to:d.barejid,type:d.chatType}).c("gone",{xmlns:"http://jabber.org/protocol/chatstates"}))}}}));Application.ChatPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},getJidByHandle:function(d){return this.barejid},buildItems:function(){this.gp=this.items.items[0];this.te=this.items.items[1];this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3]);this.gp.getTopToolbar().remove(this.gp.getTopToolbar().items.items[3])}});
Ext.reg("chatpanel",Application.ChatPanel);Ext.ns("Application");
Application.LiveViewport=Ext.extend(Ext.Viewport,{initComponent:function(){var d={xtype:"panel",region:"north",height:10,hidden:!0,title:"Map Disabled by URL"};this.initialConfig.enableMap&&(d={xtype:"panel",layout:"border",region:"north",collapsible:!0,title:"Map Panel",height:300,split:!0,items:[Application.MapPanel,Application.LayerTree]});this.items=[Application.Control,{xtype:"panel",region:"center",layout:"border",items:[d,new Application.ChatTabPanel({id:"chatpanel",region:"center",split:!0})]}];
Ext.apply(this,Ext.apply(this.initialConfig,{layout:"border"}));Application.LiveViewport.superclass.initComponent.call(this);this.doStuff()},doStuff:function(){var d=Ext.getCmp("map");d&&(d.map.events.register("changelayer",null,function(f){f={lstring:""};Application.layerstore.data.each(function(k){k=k.getLayer();k.getVisibility()&&(this.lstring+="||"+k.name)},f);Application.setPreference("layers",f.lstring)}),Ext.TaskMgr.start(Application.MapTask));new Application.DebugWindow({id:"debug",renderTo:Ext.getBody()});
(new Ext.Window({id:"loginwindow",modal:!0,closable:!1,title:"Weather.IM Live Login Options",items:[new Application.TabLoginPanel]})).show()}});Ext.ns("Application");Application.MapLegend=Ext.extend(Ext.Window,{width:300,height:200,autoScroll:!0,title:"Map Legends",hidden:!0,closeAction:"hide",initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.MapLegend.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){}});/*
 Ext JS Library 3.3.1
 Copyright(c) 2006-2010 Sencha Inc.
 licensing@sencha.com
 http://www.sencha.com/license
*/
Ext.ns("Ext.ux.grid");Ext.ux.grid.CheckColumn=Ext.extend(Ext.grid.Column,{processEvent:function(d,f,k,m,p){if("mousedown"==d){var q=k.store.getAt(m);q.set(this.dataIndex,!q.data[this.dataIndex]);return!1}return Ext.grid.ActionColumn.superclass.processEvent.apply(this,arguments)},renderer:function(d,f,k){f.css+=" x-grid3-check-col-td";return String.format('<div class="x-grid3-check-col{0}">&#160;</div>',d?"-on":"")},init:Ext.emptyFn});Ext.preg("checkcolumn",Ext.ux.grid.CheckColumn);
Ext.grid.CheckColumn=Ext.ux.grid.CheckColumn;Ext.grid.Column.types.checkcolumn=Ext.ux.grid.CheckColumn;Ext.ux.DataTip=Ext.extend(Ext.ToolTip,function(){function d(){var v=this.body||this.el;this.dataTip.renderToTarget&&this.dataTip.render(v);this.dataTip.initTarget(v)}function f(v,z){v.rendered?v.update(z):Ext.isString(z)?v.html=z:v.data=z}function k(v){var z=Ext.fly(v.triggerElement).findParent("div.x-tree-node-el",null,!0);if(z=z?v.host.getNodeById(z.getAttribute("tree-node-id","ext")):null)f(v,z.attributes);else return!1}function m(v){var z=this.host.getStore().getAt(this.host.getView().findRowIndex(v.triggerElement));
if(z)f(v,z.data);else return!1}function p(v){var z=this.host.getRecord(v.triggerElement);if(z)f(v,z.data);else return!1}function q(v){var z=Ext.fly(v.triggerElement).child("input,textarea");if((z=z?this.host.getForm().findField(z.id):null)&&(z.tooltip||v.tpl))f(v,z.tooltip||z);else return!1}function u(v){var z=this.host.store.getAt(this.host.selectedIndex);if(z)f(v,z.data);else return!1}return{init:function(v){v.dataTip=this;this.host=v;v instanceof Ext.tree.TreePanel?(this.delegate=this.delegate||
"div.x-tree-node-el",this.on("beforeshow",k)):v instanceof Ext.grid.GridPanel?(this.delegate=this.delegate||v.getView().rowSelector,this.on("beforeshow",m)):v instanceof Ext.DataView?(this.delegate=this.delegate||v.itemSelector,this.on("beforeshow",p)):v instanceof Ext.FormPanel?(this.delegate="div.x-form-item",this.on("beforeshow",q)):v instanceof Ext.form.ComboBox&&(this.delegate=this.delegate||v.itemSelector,this.on("beforeshow",u));v.rendered?d.call(v):v.onRender=v.onRender.createSequence(d)}}}());Ext.ns("Application");
function onBuddyPresence(d){var f=d.getAttribute("from"),k=Strophe.getBareJidFromJid(f),m=Strophe.getResourceFromJid(f),p=Strophe.getNodeFromJid(f),q="Available";p==Application.USERNAME&&m!=Application.XMPPRESOURCE&&m.match(/^WeatherIM/)&&("unavailable"==d.getAttribute("type")?Application.log("Self presence: ["+p+"] ["+m+"] unavailable"):Application.log("Self presence: ["+p+"] ["+m+"] available"));0<$(d).find("status").length&&(q=$(d).find("status").text());"subscribe"==d.getAttribute("type")?Ext.Msg.show({title:"New Buddy Request",
msg:"User "+p+" wishes to add you as a buddy. Is this okay?",buttons:Ext.Msg.YESNO,fn:function(u){"yes"==u?(u=$pres({to:f,type:"subscribed"}),Application.XMPPConn.send(u.tree()),Application.buildAddBuddy(p,p,"Buddies")):(u=$pres({to:f,type:"unsubscribed"}),Application.XMPPConn.send(u.tree()))},icon:Ext.MessageBox.QUESTION}):Ext.getCmp("buddies").root.eachChild(function(u){u.eachChild(function(v){v.attributes.barejid==k&&(((res=v.attributes.resources.get(m))||v.attributes.resources.add(m,{status:q,
resource:m}),d.getAttribute("type"))?"unavailable"==d.getAttribute("type")&&(1==v.attributes.resources.length&&(v.attributes.presence="offline",v.setIconCls("buddy-offline"),v.ui.hide()),v.attributes.resources.remove(m)):(0<$(d).find("show").length?v.setIconCls("buddy-away"):v.setIconCls("buddy-online"),v.attributes.presence="online",v.ui.show(),v.attributes.resources.replace(m,{status:q,resource:m})))})})};Ext.ns("Application");
Application.AllChatMessageWindow=Ext.extend(Ext.Window,{title:"Where to send this message?",width:460,height:300,modal:!0,layout:"form",layoutConfig:{},defaults:{width:450},initComponent:function(){this.buttons=[{text:"Send Message",scope:this,handler:function(){var d=this.find("name","columns")[0];Ext.each(d.findByType("checkbox"),function(f){f.checked&&Application.XMPPConn.send($msg({to:f.name+"@"+Application.XMPPMUCHOST,type:"groupchat"}).c("body").t(this.message).up().c("html",{xmlns:"http://jabber.org/protocol/xhtml-im"}).c("body",
{xmlns:"http://www.w3.org/1999/xhtml"}).c("p").c("span",{style:"color:#"+Application.getPreference("fgcolor","000000")+";background:#"+Application.getPreference("bgcolor","FFFFFF")+";"}).t(this.message))},this);this.close()}},{text:"Cancel",handler:function(){this.ownerCt.ownerCt.close()}}];Application.AllChatMessageWindow.superclass.initComponent.apply(this,arguments);this.buildItems(this.message);this.addAvailableRooms()},addAvailableRooms:function(){Ext.getCmp("chatpanel").items.each(function(d){if("groupchat"==
d.chatType&&!d.anonymous&&(d=Strophe.getNodeFromJid(d.barejid),0==this.items.items[1].find("name",d).length)){var f=this.find("name","columns")[0];pos=f.entries%3;f.items.items[pos].add({xtype:"checkbox",hideLabel:!0,boxLabel:d,name:d});f.entries+=1}},this)},buildItems:function(d){this.add({xtype:"textarea",hideLabel:!0,html:d});this.add({xtype:"fieldset",title:"Send my message to the following room(s):",autoHeight:!0,autoScroll:!0,items:[{entries:0,name:"columns",layout:"table",items:[{layout:"form",
border:!1,colname:"col1",width:140,items:[]},{layout:"form",border:!1,colname:"col2",width:140,items:[]},{width:140,border:!1,colname:"col3",layout:"form",items:[]}]}]})}});/*
 Licensed under the terms of the Open Source <a href="http://www.gnu.org/licenses/lgpl.html">LGPL 3.0 license</a>. Commercial use is permitted to the extent that the code/component(s) do NOT become part of another Open Source or Commercially licensed development library or toolkit without explicit permission.
 @version 2.0.0 (Feb 14, 2010)
*/
Ext.namespace("Ext.ux.panel");
Ext.ux.panel.DDTabPanel=Ext.extend(Ext.TabPanel,{arrowOffsetX:-9,arrowOffsetY:-8,initComponent:function(){Ext.ux.panel.DDTabPanel.superclass.initComponent.call(this);this.addEvents("reorder");this.ddGroupId||(this.ddGroupId="dd-tabpanel-group-"+Ext.ux.panel.DDTabPanel.superclass.getId.call(this))},reorder:function(d){this.fireEvent("reorder",this,d)},afterRender:function(){Ext.ux.panel.DDTabPanel.superclass.afterRender.call(this);this.arrow=Ext.DomHelper.append(Ext.getBody(),'<div class="dd-arrow-down"></div>',
!0);this.arrow.hide();this.dd=new Ext.ux.panel.DDTabPanel.DropTarget(this,{ddGroup:this.ddGroupId});this.move=!1},initTab:function(d,f){Ext.ux.panel.DDTabPanel.superclass.initTab.call(this,d,f);f=this.id+"__"+d.id;Ext.fly(f).on("click",function(){d.ownerCt.setActiveTab(d.id)});Ext.applyIf(d,{allowDrag:!0});Ext.apply(d,{ds:new Ext.dd.DragSource(f,{ddGroup:this.ddGroupId,dropEl:d,dropElHeader:Ext.get(f,!0),scroll:!1,onStartDrag:function(){if(this.dropEl.iconCls){var k=this.getProxy().getGhost().select(".x-tab-strip-text");
k.addClass("x-panel-inline-icon");var m=k.elements[0].innerHTML;m=Ext.util.Format.stripTags(m);k.elements[0].innerHTML=m;k.applyStyles({paddingLeft:"20px"})}},onMouseUp:function(k){this.dropEl.ownerCt.move?(this.dropEl.disabled||null!=this.dropEl.ownerCt.activeTab||this.dropEl.ownerCt.setActiveTab(this.dropEl),this.dropEl.ownerCt.move=!1):this.dropEl.isVisible()||this.dropEl.disabled||this.dropEl.show()}}),enableTabDrag:function(){this.allowDrag=!0;return this.ds.unlock()},disableTabDrag:function(){this.allowDrag=
!1;return this.ds.lock()}});d.allowDrag?d.enableTabDrag():d.disableTabDrag()},onRemove:function(d){var f=Ext.get(d.tabEl);f&&(f.select("a").removeAllListeners(),Ext.destroy(f));Ext.TabPanel.superclass.onRemove.call(this,d);this.stack.remove(d);delete d.tabEl;d.un("disable",this.onItemDisabled,this);d.un("enable",this.onItemEnabled,this);d.un("titlechange",this.onItemTitleChanged,this);d.un("iconchange",this.onItemIconChanged,this);d.un("beforeshow",this.onBeforeShowItem,this);d==this.activeTab&&(this.move?
this.activeTab=null:(d=this.stack.next())?this.setActiveTab(d):0<this.items.getCount()?this.setActiveTab(0):this.activeTab=null);this.destroying||this.delegateUpdates()},onDestroy:function(){Ext.destroy(this.dd,this.arrow);Ext.ux.panel.DDTabPanel.superclass.onDestroy.call(this)}});
Ext.ux.panel.DDTabPanel.DropTarget=Ext.extend(Ext.dd.DropTarget,{constructor:function(d,f){this.tabpanel=d;Ext.ux.panel.DDTabPanel.DropTarget.superclass.constructor.call(this,d.stripWrap,f)},notifyOver:function(d,f,k){var m=this.tabpanel.items,p=m.length;if(!f.within(this.getEl())||d.dropEl==this.tabpanel)return"x-dd-drop-nodrop";k=this.tabpanel.arrow;var q=this.el.getY();f=f.getPageX();for(var u=0;u<p;u++){var v=z;var z=m.itemAt(u);var O=z.ds.dropElHeader,F=O.getX();if(f<=F+O.dom.clientWidth/2){var G=
F;break}}if("undefined"==typeof G){G=m.itemAt(p-1);if(G==d.dropEl)return"x-dd-drop-nodrop";d=G.ds.dropElHeader.dom;G=(new Ext.Element(d)).getX()+d.clientWidth+3}else if(z==d.dropEl||v==d.dropEl)return this.tabpanel.arrow.hide(),"x-dd-drop-nodrop";k.setTop(q+this.tabpanel.arrowOffsetY).setLeft(G+this.tabpanel.arrowOffsetX).show();return"x-dd-drop-ok"},notifyDrop:function(d,f,k){this.tabpanel.arrow.hide();if(d.dropEl==this.tabpanel)return!1;k=this.tabpanel.items;var m=f.getPageX();for(f=0;f<k.length;f++){var p=
k.itemAt(f),q=p.ds.dropElHeader;q=q.getX()+q.dom.clientWidth/2;if(m<=q)break}if(p==d.dropEl||k.itemAt(f-1)==d.dropEl)return!1;d.proxy.hide();d.dropEl.ownerCt==this.tabpanel&&f>k.indexOf(d.dropEl)&&f--;this.tabpanel.move=!0;d=d.dropEl.ownerCt.remove(d.dropEl,!1);this.tabpanel.insert(f,d);this.tabpanel.fireEvent("drop",this.tabpanel);this.tabpanel.reorder(k.itemAt(f));return!0},notifyOut:function(d,f,k){this.tabpanel.arrow.hide()}});Ext.reg("ddtabpanel",Ext.ux.panel.DDTabPanel);Ext.ns("Application");
Application.ChatTabPanel=Ext.extend(Ext.ux.panel.DDTabPanel,{activeTab:0,deferredRender:!1,split:!0,enableTabScroll:!0,initComponent:function(){Ext.apply(this,Ext.apply(this.initialConfig,{}));Application.ChatTabPanel.superclass.initComponent.apply(this,arguments);this.buildItems()},buildItems:function(){this.add({contentEl:"help",title:"Help",preventBodyReset:!0,style:{margin:"5px"},autoScroll:!0});this.add(new Application.MUCChatPanel({title:"All Chats",closable:!1,chatType:"allchats",barejid:"__allchats__@"+
Application.XMPPMUCHOST,id:"__allchats__"}))},addMUC:function(d,f,k){d=new Application.MUCChatPanel({title:Strophe.getNodeFromJid(d),barejid:d,handle:f,anonymous:k});return this.add(d)},getMUC:function(d){return this.find("barejid",d)[0]},removeMUC:function(d){this.remove(this.getMUC(d))},addChat:function(d){var f=Strophe.getNodeFromJid(d);Strophe.getDomainFromJid(d)==Application.XMPPMUCHOST&&(f=Strophe.getResourceFromJid(d));d=new Application.ChatPanel({title:f,handle:Application.USERNAME,barejid:d});
return this.add(d)},getChat:function(d){return this.find("barejid",d)[0]},removeChat:function(d){this.remove(this.getChat(d))}});Ext.reg("chattabpanel",Application.ChatTabPanel);Ext.ns("Application");function iembotFilter(d,f){return"iembot"==d.get("author")?!1:!0}
function grid2html(d){var f=d.getStore();d=d.ownerCt.title;t="<html><head></head><body>";t+="<table cellpadding='2' cellspacing='0' border='1'><tr><th>Roomname</th><th>Date</th><th>Author</th><th>Message</th></tr>";for(var k=0;k<f.getCount();k++)row=f.getAt(k),t+=String.format("<tr><td>{0}</td><td>{1}</td><td>{2}</td><td>{3}</td></tr>\r\n",row.get("roomname")||d,row.get("ts").format("Y/m/d g:i A"),row.get("author"),row.get("message"));return t+="</table></body></html>"}
function htmlExport(d){Ext.isIE6||Ext.isIE7||Ext.isSafari||Ext.isSafari2||Ext.isSafari3?Ext.Msg.alert("Status","Sorry, this tool does not work with this browser."):(t=grid2html(d),document.location="data:plain/html;base64,"+encode64(t))}function showHtmlVersion(d){(new Ext.Window({title:"Text Version",closable:!0,width:600,height:350,plain:!0,autoScroll:!0,html:grid2html(d)})).show()}
var LinkInterceptor={render:function(d){d.body.on({mousedown:function(f,k){k.target="_blank";Application.TextWindow.hide()},click:function(f,k){"_blank"!=String(k.target).toLowerCase()&&(f.stopEvent(),window.open(k.href));Application.TextWindow.hide()},delegate:"a"})}};Ext.ns("Application");Application.saveViews=function(){for(var d=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}),f=1;6>f;f++)(bnds=Ext.getCmp("mfv"+f).bounds)&&d.c("view",{label:Ext.getCmp("mfv"+f).getValue(),bounds:bnds.left+","+bnds.bottom+","+bnds.right+","+bnds.top}).up();Application.XMPPConn.sendIQ(d.tree())};Ext.util.Format.comboRenderer=function(d){return function(f){return(f=d.findRecord(d.valueField,f))?f.get(d.displayField):d.valueNotFoundText}};
Application.SoundStore=new Ext.data.ArrayStore({fields:["id","label","src"],data:[["default","Default","sounds/message_new.mp3"],["bleep","Bleep","sounds/bleep.mp3"],["cow","Cow (Mooo!)","sounds/cow.mp3"],["doorbell","Door Bell","sounds/doorbell.mp3"],["eas","EAS Beep","sounds/eas.mp3"],["elevator","Elevator","sounds/elevator.mp3"]]});
var combo=new Ext.form.ComboBox({typeAhead:!1,triggerAction:"all",lazyRender:!0,mode:"local",store:Application.SoundStore,listeners:{change:function(d,f,k){Application.playSound(f)}},valueField:"id",displayField:"label"});
Application.soundPrefs=new Ext.Window({title:"Sound Preferences",width:500,height:300,closeAction:"hide",layout:"form",buttons:[{text:"Save Sound Settings",handler:function(){Ext.getCmp("soundpanel").getStore().each(function(d){eidx=d.get("id");Application.setPreference("sound::"+eidx+"::enabled",d.get("enabled")?"true":"false");Application.setPreference("sound::"+eidx+"::sound",d.get("sound"))});Application.soundPrefs.hide();Application.syncPreferences()}}],items:[{xtype:"slider",id:"volume",minValue:0,
maxValue:100,value:50,width:200,listeners:{changecomplete:function(d,f,k){Application.setPreference("volume",f);Application.MsgBus.fireEvent("soundevent","default")}},fieldLabel:"Volume"},new Ext.grid.EditorGridPanel({store:new Ext.data.ArrayStore({data:[["new_message","New Message (Non IEMBot)",!0,"default"],["new_conversation","New Conversation",!0,"doorbell"],["iembot","IEMBot Message",!0,"default"],["myhandle","Message with your name in it",!0,"bleep"],["tornado",'Message with "Tornado" within text',
!0,"eas"]],fields:[{name:"id",type:"string"},{name:"label",type:"string"},{name:"enabled",type:"bool"},{name:"sound",type:"string"}],sortInfo:{field:"label",direction:"ASC"}}),cm:new Ext.grid.ColumnModel({columns:[{dataIndex:"enabled",id:"enabled",header:"Enable",xtype:"checkcolumn"},{dataIndex:"label",id:"label",sortable:!0,header:"Event Type"},{dataIndex:"sound",id:"sound",header:"Sound",renderer:Ext.util.Format.comboRenderer(combo),editor:combo}]}),id:"soundpanel",title:"Sound Events",frame:!0,
clicksToEdit:1,stripeRows:!0,autoExpandColumn:"label",height:200,autoScroll:!0})]});
Application.boundsFavorites=new Ext.Window({title:"Map View Favorites",width:500,height:300,closeAction:"hide",layout:"table",layoutConfig:{columns:4},autoScroll:!0,buttons:[{text:"Save Settings",handler:function(){for(var d=1;6>d;d++)nval=Ext.getCmp("mfv"+d).getValue(),""!=nval&&Ext.getCmp("fm"+d).setText(nval);Application.boundsFavorites.hide()}}],items:[{html:"This form allows you to modify the 5 allowed map extent favorites. The first favorite will be your default view when you log in and for the star icon above.",colspan:4},
{html:"#1"},{xtype:"textfield",id:"mfv1",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(d,f){Ext.getCmp("mfv1").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(d,f){(bnds=Ext.getCmp("mfv1").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#2"},{xtype:"textfield",id:"mfv2",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(d,f){Ext.getCmp("mfv2").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(d,f){(bnds=Ext.getCmp("mfv2").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#3"},{xtype:"textfield",id:"mfv3",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(d,f){Ext.getCmp("mfv3").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(d,f){(bnds=Ext.getCmp("mfv3").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,
!0)}},{html:"#4"},{xtype:"textfield",id:"mfv4",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(d,f){Ext.getCmp("mfv4").bounds=Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(d,f){(bnds=Ext.getCmp("mfv4").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}},{html:"#5"},{xtype:"textfield",id:"mfv5",bounds:null,width:200},{xtype:"button",text:"Set From Current View",handler:function(d,f){Ext.getCmp("mfv5").bounds=
Ext.getCmp("map").map.getExtent();Application.saveViews()}},{xtype:"button",text:"View",handler:function(d,f){(bnds=Ext.getCmp("mfv5").bounds)&&Ext.getCmp("map").map.zoomToExtent(bnds,!0)}}]});
mucform=new Ext.form.FormPanel({labelWidth:200,padding:5,items:[{xtype:"textfield",allowBlank:!1,name:"roomname",fieldLabel:"Room Name"},{xtype:"textfield",allowBlank:!1,name:"roomhandle",value:Application.USERNAME,fieldLabel:"Chat Handle"},{xtype:"checkbox",name:"bookmark",fieldLabel:"Save Bookmark for Chatroom?",handler:function(d,f){f?mucform.getForm().findField("roomalias").enable():mucform.getForm().findField("roomalias").disable()}},{xtype:"textfield",name:"roomalias",fieldLabel:"Bookmark Alias (optional)",
disabled:!0},{xtype:"checkbox",name:"anonymous",fieldLabel:"Anonymously Monitor (read-only)"},{xtype:"checkbox",name:"autojoin",fieldLabel:"Auto Join Room after Login"}],listeners:{render:function(){mucform.getForm().findField("roomhandle").getValue()||mucform.getForm().findField("roomhandle").setValue(Application.USERNAME)}}});var privform=new Ext.form.FormPanel({labelWidth:100,padding:5,items:[{xtype:"textfield",fieldLabel:"User Name",emptyText:"media-joe.blow",name:"username"}]});
Application.CreatePrivateChat=new Ext.Window({width:400,title:"Chat with User",items:[privform],buttons:[{xtype:"button",text:"Start Chat",scope:privform,handler:function(){var d=this.getForm().findField("username").getValue();-1==d.indexOf("@")&&(d=d+"@"+Application.XMPPHOST);Application.CreatePrivateChat.hide();(cp=Ext.getCmp("chatpanel").getChat(d))||(cp=Ext.getCmp("chatpanel").addChat(d));Ext.getCmp("chatpanel").setActiveTab(cp)}},{xtype:"button",text:"Cancel",handler:function(){Application.CreatePrivateChat.hide()}}]});
Application.JoinChatroomDialog=new Ext.Window({width:400,title:"Join a Group Chat",items:[mucform],buttons:[{xtype:"button",text:"Join Room",scope:mucform,handler:function(){roomname=this.getForm().findField("roomname").getValue();room=roomname+"@conference."+Application.XMPPHOST;handle=this.getForm().findField("roomhandle").getValue();ibook=this.getForm().findField("bookmark").getValue();anonymous=this.getForm().findField("anonymous").getValue();autojoin=this.getForm().findField("autojoin").getValue();
ibook&&(alias=this.getForm().findField("roomalias").getValue(),""==alias&&(alias=roomname),Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+roomname+")",jid:room,alias,anonymous,autojoin,icon:"icons/chat.png",handle,leaf:!0}));Application.MsgBus.fireEvent("joinchat",room,handle,anonymous);Application.JoinChatroomDialog.hide()}},{xtype:"button",text:"Cancel",handler:function(){Application.JoinChatroomDialog.hide()}}]});Application.msgtpl=new Ext.XTemplate('<p>{date:date("g:i:s A")} :: {msg}</p>');
Application.TextWindow=new Ext.Window({width:550,height:300,title:"Product Text",closeAction:"hide",constrain:!0,hidden:!0,autoScroll:!0,html:"Loading...."});Application.log=function(d){Ext.getCmp("debug").addMessage(d)};Ext.ns("Application");function saveBookmarks(){var d=Ext.getCmp("bookmarks").root,f=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"});d.eachChild(function(k){this.c("conference",{name:k.attributes.alias,anonymous:k.attributes.anonymous?"true":"false",autojoin:k.attributes.autojoin?"true":"false",jid:k.attributes.jid}).c("nick",k.attributes.handle).up().up()},f);Application.XMPPConn.sendIQ(f.tree())}
function onPresenceCheck(d,f){"available"==d.xmpp?Application.XMPPConn.send($pres()):Application.XMPPConn.send($pres().c("show","away").up().c("status",d.xmpp));Ext.getCmp("presenceUI").setText(d.text)}
Application.Control={region:"west",title:"Weather.IM Live",collapsible:!0,width:200,split:!0,layout:"accordion",layoutConfig:{autoWidth:!1},autoScroll:!0,tbar:[{text:"Actions",menu:[{checked:!1,text:"Show Offline Buddies",checkHandler:function(d,f){Ext.getCmp("buddies").root.cascade(function(k){f?k.ui.show():"offline"==k.attributes.presence&&k.ui.hide()})}},{xtype:"menuitem",text:"Chat with User",handler:function(){Application.CreatePrivateChat.show()}},{xtype:"menuitem",text:"Add Buddy...",handler:function(){Application.buildAddBuddy(null,
null,null)}},{xtype:"menuitem",text:"Join Group Chat",handler:function(){Application.JoinChatroomDialog.show()}},{text:"Msg Text Color",menu:{items:[new Ext.ColorPalette({id:"fgcolor",value:"000000",listeners:{select:function(d,f){Application.setPreference("fgcolor",f)}}})]}},{text:"Msg Background Color",menu:{items:[new Ext.ColorPalette({id:"bgcolor",value:"FFFFFF",listeners:{select:function(d,f){Application.setPreference("bgcolor",f)}}})]}},{xtype:"menuitem",text:"Show Debug Window",handler:function(){Ext.getCmp("debug").show()}},
{xtype:"menuitem",text:"Log Out",handler:function(){Application.log("Manual logout requested.");Application.RECONNECT=!1;Application.XMPPConn.disconnect()}}]},{xtype:"tbseparator"},{text:"Available",id:"presenceUI",menu:{items:[{text:"Available",xmpp:"available",checked:!0,group:"presence",checkHandler:onPresenceCheck},{text:"Be Right Back",xmpp:"Be Right Back",checked:!1,group:"presence",checkHandler:onPresenceCheck},{text:"Away",xmpp:"away",checked:!1,group:"presence",checkHandler:onPresenceCheck}]}},
{xtype:"splitbutton",id:"sound",scale:"medium",soundOn:!0,handler:function(d){d.soundOn?(d.setIcon("icons/mute.png"),soundManager.muteAll(),d.soundOn=!1):(d.setIcon("icons/volume.png"),soundManager.unmuteAll(),d.soundOn=!0,Application.MsgBus.fireEvent("soundevent","default"))},arrowHandler:function(){Application.soundPrefs.show()},icon:"icons/volume.png"}],items:[{flex:1,xtype:"treepanel",id:"buddies",title:"Buddies",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,plugins:new Ext.ux.DataTip({tpl:new Ext.XTemplate('<tpl if="typeof(resources) !== &quot;undefined&quot;">',
"<div>",'<tpl for="resources.items">',"<p><b>Resource:</b> {resource} <b>Status:</b> {status}</p>","</tpl>","</div>","</tpl>")}),listeners:{click:function(d){(cp=Ext.getCmp("chatpanel").getChat(d.attributes.barejid))||(cp=Ext.getCmp("chatpanel").addChat(d.attributes.barejid));Ext.getCmp("chatpanel").setActiveTab(cp)}},root:new Ext.tree.TreeNode},{flex:1,xtype:"treepanel",id:"bookmarks",title:"Chatroom Bookmarks",collapsed:!1,rootVisible:!1,enableDD:!0,lines:!1,containerScroll:!0,autoScroll:!0,plugins:new Ext.ux.DataTip({tpl:"<div>Anonymous: {anonymous}<br />Autojoin: {autojoin}</div>"}),
contextMenu:new Ext.menu.Menu({items:[{id:"delete-node",icon:"icons/close.png",text:"Delete Bookmark"}],listeners:{itemclick:function(d){var f=d.parentMenu.contextNode;switch(d.id){case "delete-node":f.parentNode&&(f.remove(),saveBookmarks())}}}}),listeners:{contextmenu:function(d,f){d.select();var k=d.getOwnerTree().contextMenu;k.contextNode=d;k.showAt(f.getXY())},movenode:function(d,f,k,m,p){saveBookmarks()},click:function(d){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();
form.findField("roomname").setValue(Strophe.getNodeFromJid(d.attributes.jid));form.findField("roomhandle").setValue(d.attributes.handle);form.findField("bookmark").enable();form.findField("anonymous").setValue(d.attributes.anonymous);form.findField("autojoin").setValue(d.attributes.autojoin);form.findField("roomalias").setValue(d.attributes.alias)})}},root:new Ext.tree.TreeNode({initialLoad:!1,listeners:{beforeappend:function(d,f,k,m){if(d=f.findChild("jid",k.attributes.jid))Application.log("Replacing MUC bookmark: "+
k.attributes.jid),f.removeChild(d,!0);return!0},append:function(d,f,k,m){f.initialLoad&&saveBookmarks()}}})},{flex:2,xtype:"treepanel",id:"chatrooms",title:"Chatrooms",collapsed:!1,rootVisible:!1,lines:!1,autoScroll:!0,containerScroll:!0,listeners:{click:function(d){Application.JoinChatroomDialog.show(null,function(){form=this.items.items[0].getForm();form.findField("roomname").setValue(Strophe.getNodeFromJid(d.attributes.jid));form.findField("roomhandle").setValue(Application.USERNAME);form.findField("bookmark").enable();
form.findField("anonymous").setValue(!1);form.findField("autojoin").setValue(!1);form.findField("roomalias").setValue(Strophe.getNodeFromJid(d.attributes.jid))})}},root:new Ext.tree.TreeNode}]};
Application.doLogin=function(){Application.RECONNECT=!0;Application.ATTEMPTS+=1;11<Application.ATTEMPTS?Application.log("Application Login Limit Reached!"):(username=Ext.getCmp("username").getValue(),0<username.indexOf("@")&&(username=Strophe.getNodeFromJid(username)),username=username.toLowerCase(),username=username.replace(/^\s+|\s+$/g,""),password=Ext.getCmp("password").getValue(),""==username?Application.log("Invalid Username"):""==password?Application.log("Invalid Password"):Application.login(username,
password))};Ext.ns("Application");Application.ServiceGuard={skipFirst:!0,run:function(){this.skipFirst?this.skipFirst=!1:Application.XMPPConn&&Application.XMPPConn.authenticated&&0!=Application.XMPPConn.errors&&Application.log("Strophe error counter is non-zero: "+Application.XMPPConn.errors)},interval:12E4};function UTCStringToDate(d,f){d=Date.parseDate(d,f);return void 0==d?"":d.fromUTC()}
function buildXMPP(){Application.log("Initializing XMPPConn Obj");Application.XMPPConn=new Strophe.Connection(Application.BOSH);Application.XMPPConn.disco.addFeature("http://jabber.org/protocol/chatstates");Application.DEBUGMODE&&(Application.XMPPConn.rawInput=rawInput,Application.XMPPConn.rawOutput=rawOutput)}
Application.login=function(d,f){jid=d+"@"+Application.XMPPHOST+"/"+Application.XMPPRESOURCE;"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(jid,f,onConnect,60,1,Application.ROUTE)};Application.doAnonymousLogin=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.connect(Application.XMPPHOST,null,onConnect)};
Application.register=function(){"undefined"===typeof Application.XMPPConn&&buildXMPP();Application.XMPPConn.register.connect(Application.XMPPHOST,function(d){d===Strophe.Status.REGISTER?(Application.log("Strophe.Status.REGISTER"),Application.XMPPConn.register.fields.username=Ext.get("reguser").getValue(),Application.XMPPConn.register.fields.password=Ext.get("regpass").getValue(),Application.XMPPConn.register.fields.email=Ext.get("regemail").getValue(),Application.XMPPConn.register.submit()):d===Strophe.Status.REGISTERED?
(Ext.getCmp("loginpanel").addMessage("Username "+Application.XMPPConn.register.fields.username+" registered with server ..."),Ext.getCmp("loginwindow").items.items[0].activate(0),Ext.getCmp("username").setValue(Application.XMPPConn.register.fields.username),Ext.getCmp("password").setValue(Application.XMPPConn.register.fields.password),Application.XMPPConn.disconnect(),Application.doLogin()):d===Strophe.Status.CONFLICT?Application.log("Contact already existed!"):d===Strophe.Status.NOTACCEPTABLE?Application.log("Registration form not properly filled out."):
d===Strophe.Status.REGIFAIL?Application.log("The Server does not support In-Band Registration"):d===Strophe.Status.CONNECTED?(Application.log("connected?"),Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid)):Application.log(d)})};
function onConnect(d){if(d==Strophe.Status.CONNECTING)Application.log("Strophe.Status.CONNECTING...");else if(d==Strophe.Status.ERROR)Application.log("Strophe.Status.ERROR...");else if(d==Strophe.Status.AUTHFAIL)Application.log("Strophe.Status.AUTHFAIL..."),Application.RECONNECT=!1,Ext.getCmp("loginpanel").addMessage("Authentication failed, please check username and password..."),Application.XMPPConn.disconnect();else if(d==Strophe.Status.CONNFAIL)Application.log("Strophe.Status.CONNFAIL...");else if(d==
Strophe.Status.DISCONNECTED)Application.log("Strophe.Status.DISCONNECTED..."),Application.MsgBus.fireEvent("loggingout"),Application.RECONNECT?(Application.log("Relogging in after 3 seconds delay"),Application.doLogin.defer(3E3,this)):Application.MsgBus.fireEvent("loggedout");else if(d==Strophe.Status.AUTHENTICATING)Application.log("Strophe.Status.AUTHENTICATING...");else if(d==Strophe.Status.DISCONNECTING)Application.log("Strophe.Status.DISCONNECTING..."),Application.XMPPConn.flush();else if(d==
Strophe.Status.ATTACHED)Application.log("Strophe.Status.ATTACHED...");else if(d==Strophe.Status.CONNECTED){Application.log("Strophe.Status.CONNECTED...");Application.USERNAME=Strophe.getNodeFromJid(Application.XMPPConn.jid);Application.RECONNECT=!0;Application.XMPPConn.addHandler(onMessage,null,"message",null,null,null);Application.XMPPConn.addHandler(onPresence,null,"presence",null,null,null);Application.XMPPConn.addHandler(onRoster,Strophe.NS.ROSTER,"iq",null,null,null);Application.XMPPConn.addHandler(onIQ,
null,"iq",null,null,null);Application.XMPPConn.send($iq({type:"get"}).c("query",{xmlns:Strophe.NS.ROSTER}).tree());var f=0;Ext.getCmp("chatpanel").items.each(function(k){if("groupchat"==k.chatType){Application.log("Attempting to rejoin MUC: "+k.barejid);var m=$pres({to:k.barejid+"/"+k.handle});k.anonymous&&m.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");(function(){Application.XMPPConn.send(this.p)}).defer(5E3*f,{p:m});f+=1}});d=$iq({type:"get",id:"_get3"}).c("query",
{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"}).tree();Application.XMPPConn.sendIQ(d,parsePrefs);d=$iq({type:"get",id:"_get2"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:views"}).tree();Application.XMPPConn.sendIQ(d,parseViews);Application.MsgBus.fireEvent("loggedin")}}
function updateMap(){var d=Application.getPreference("layers");if(null!=d){d=d.split("||");for(var f=0;f<d.length;f++)""!=d[f]&&(idx=Application.layerstore.find("title",d[f]),-1!=idx&&(Application.log("Setting Layer "+d[f]+" visable"),layer=Application.layerstore.getAt(idx).getLayer(),layer.setVisibility(!0)))}}
function setSounds(){Application.prefStore.each(function(d){key=d.get("key");"volume"==key?Ext.getCmp("volume").setValue(d.get("value")):0==key.indexOf("sound::")&&(tokens=key.split("::"),3==tokens.length&&(sidx=tokens[1],opt=tokens[2],store=Ext.getCmp("soundpanel").getStore(),idx=store.find("id",sidx),-1<idx&&(lrecord=store.getAt(idx),val=d.get("value"),"true"==val&&(val=!0),"false"==val&&(val=!1),lrecord.set(opt,val))))})}
function parsePrefs(d){Application.prefStore.removeAll();d=$(d).find("pref");for(var f=0;f<d.length;f++)key=d[f].getAttribute("key"),value=d[f].getAttribute("value"),Application.setPreference(key,value);Application.prefStore.locked=!0;setSounds();try{var k=parseInt(Application.getPreference("font-size",14))+2;cssfmt=String.format("normal {0}px arial",k);Ext.util.CSS.updateRule("td.x-grid3-td-message","font",cssfmt);Ext.util.CSS.updateRule(".message-entry-box","font",cssfmt);updateMap();Application.updateColors()}catch(m){}Application.prefStore.locked=
!1}function parseViews(d){if(Ext.getCmp("map"))for(elem=$(d).find("view"),d=0;d<elem.length;d++)label=elem[d].getAttribute("label"),bounds=elem[d].getAttribute("bounds"),""!=label&&(Ext.getCmp("mfv"+(d+1)).setValue(label),Ext.getCmp("fm"+(d+1)).setText(label)),Ext.getCmp("mfv"+(d+1)).bounds=OpenLayers.Bounds.fromArray(bounds.split(",")),0==d&&Ext.getCmp("map").map.zoomToExtent(OpenLayers.Bounds.fromArray(bounds.split(",")),!0)}
function parseBookmarks(d){elem=$(d).find("conference");for(var f=d=0;f<elem.length;f++){alias=elem[f].getAttribute("name");jid=elem[f].getAttribute("jid");nick=$(elem[f]).find("nick").text();if(null==nick||""==nick)nick=Application.USERNAME;anonymous="true"==elem[f].getAttribute("anonymous");autojoin="true"==elem[f].getAttribute("autojoin");Ext.getCmp("bookmarks").root.appendChild({text:alias+" ("+Strophe.getNodeFromJid(jid)+")",jid,alias,autojoin,iconCls:"chatroom-icon",handle:nick,anonymous,leaf:!0});
autojoin&&null==Ext.getCmp("chatpanel").getMUC(jid)&&(Application.log("Autojoining MUC: "+jid),function(){Application.MsgBus.fireEvent("joinchat",this.jid,this.nick,this.anonymous)}.defer(5E3*d,{jid,nick,anonymous}),d+=1)}Ext.getCmp("bookmarks").root.initialLoad=!0}function onIQ(d){try{iqParser(d)}catch(k){d="IQ Bug\n:"+(Strophe.xmlescape(Strophe.serialize(d))+"\n");for(var f in k)d+="property: "+f+" value: ["+k[f]+"]\n";d+="toString():  value: ["+k.toString()+"]";Application.log(d)}return!0}
function iqParser(d){if("fetchrooms"==d.getAttribute("id")){items=d.firstChild.getElementsByTagName("item");for(d=0;d<items.length;d++)Ext.getCmp("chatrooms").root.appendChild({text:items[d].getAttribute("name")+" ("+Strophe.getNodeFromJid(items[d].getAttribute("jid"))+")",jid:items[d].getAttribute("jid"),iconCls:"chatroom-icon",leaf:!0});myTreeSorter=new Ext.tree.TreeSorter(Ext.getCmp("chatrooms"),{folderSort:!0,dir:"asc"});myTreeSorter.doSort(Ext.getCmp("chatrooms").getRootNode())}}
function onRoster(d){try{rosterParser(d)}catch(k){d="Roster Bug\n:"+(Strophe.xmlescape(Strophe.serialize(d))+"\n");for(var f in k)d+="property: "+f+" value: ["+k[f]+"]\n";d+="toString():  value: ["+k.toString()+"]";Application.log(d)}return!0}
function rosterParser(d){var f=Ext.getCmp("buddies").root;d=$(d).find("item");for(var k=0;k<d.length;k++)for(var m=$(d[k]).find("group"),p=0;p<m.length;p++){var q=$(m[p]);child=f.findChild("group",q.text())||f.appendChild({leaf:!1,group:q.text(),text:q.text(),expanded:!0,loaded:!0});child.appendChild({text:d[k].getAttribute("name"),barejid:d[k].getAttribute("jid"),resources:new Ext.util.MixedCollection,iconCls:"buddy-offline",presence:"offline",hidden:!0,leaf:!0})}Application.XMPPConn.send($pres().tree());
var u=$iq({type:"get",id:"_get1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"storage:bookmarks"}).tree();(function(){Application.XMPPConn.sendIQ(u,parseBookmarks)}).defer(3E3,this);return!0}function onPresence(d){try{presenceParser(d)}catch(k){d="Presence Bug\n:"+(Strophe.xmlescape(Strophe.serialize(d))+"\n");for(var f in k)d+="property: "+f+" value: ["+k[f]+"]\n";d+="toString():  value: ["+k.toString()+"]";Application.log(d)}return!0}
function getMUCIcon(d,f){return"owner"==d?"icons/owner.png":"admin"==d?"icons/admin.png":"icons/participant.png"}
function presenceParser(d){var f=d.getAttribute("from");if(Strophe.getDomainFromJid(f)=="conference."+Application.XMPPHOST)if(room=Strophe.getBareJidFromJid(f),mcp=Ext.getCmp("chatpanel").getMUC(room),null==mcp)Application.log("ERROR: got presence from non-existant room: "+room);else{if(0<$(d).find("status").length&&(error=$(d).find("status"),"201"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, chatroom ["+room+"] does not exist.");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<
$(d).find("error").length&&(error=$(d).find("error"),"407"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your account is not authorized to access chatroom ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(d).find("error").length&&(error=$(d).find("error"),"409"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Sorry, your requested chatroom handle is already in use by room ["+room+"]");Ext.getCmp("chatpanel").removeMUC(room);return}if(0<$(d).find("status").length&&
(error=$(d).find("status"),"307"==error[0].getAttribute("code"))){Ext.Msg.alert("Status","Your account signed into this chatroom ["+room+"] with the same handle from another location. Please use unique handles.");mcp.joinedChat=!1;Ext.getCmp("chatpanel").removeMUC(room);return}child=mcp.roomusers.root.findChild("text",Strophe.getResourceFromJid(f));var k=$(d).find("item"),m=f;if(0<k.length){m=k[0].getAttribute("jid")||m;var p=k[0].getAttribute("role");var q=k[0].getAttribute("affiliation");k=$(k[0]).find("role");
if(0<k.length)try{p=k.text()}catch(v){k="roletest bug\n:"+(Strophe.xmlescape(Strophe.serialize(d))+"\n");for(var u in v)k+="property: "+u+" value: ["+v[u]+"]\n";k+="toString():  value: ["+v.toString()+"]";Application.log(k)}}null!=d.getAttribute("type")||child||"visitor"==p||(mcp.joinedChat=!0,mcp.roomusers.root.appendChild({affiliation:q,role:p,icon:getMUCIcon(q,p),text:Strophe.getResourceFromJid(f),jid:m,leaf:!0}));"unavailable"==d.getAttribute("type")&&child&&mcp.roomusers.root.removeChild(child)}else onBuddyPresence(d)}
function onMessage(d){try{messageParser(d)}catch(k){d="Message Bug\n:"+(Strophe.xmlescape(Strophe.serialize(d))+"\n");for(var f in k)d+="property: "+f+" value: ["+k[f]+"]\n";d+="toString():  value: ["+k.toString()+"]";Application.log(d)}return!0}Application.replaceURLWithHTMLLinks=function(d){return null==d?null:d.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,"<a href='$1'>$1</a>")};
function messageParser(d){var f=d.getAttribute("from"),k=d.getAttribute("type"),m=d.getElementsByTagName("body"),p=$(d).find("delay[xmlns='urn:xmpp:delay']"),q=$(d).find("html"),u=m[0];m=!1;0<q.length?(q=$(d).find("html").find("body"),q=navigator.userAgent.match(/msie/i)?q[0].xml:$(q[0]).html(),q=q.replace(/<p/g,"<span").replace(/<\/p>/g,"</span>"),""==q&&(Application.log("Message Failure:"+d),q=Application.replaceURLWithHTMLLinks(Strophe.getText(u)))):q=Application.replaceURLWithHTMLLinks(Strophe.getText(u));
0<p.length?(u=UTCStringToDate(p[0].getAttribute("stamp").substring(0,19),"Y-m-d\\Th:i:s"),m=!0):u=new Date;if("groupchat"==k){product_id=null;p=$(d).find("x");for(k=0;k<p.length;k++)p[k].getAttribute("product_id")&&(product_id=p[k].getAttribute("product_id"));try{geomParser(d,m)}catch(v){}sender=Strophe.getResourceFromJid(f);room=Strophe.getBareJidFromJid(f);(mpc=Ext.getCmp("chatpanel").getMUC(room))&&sender&&(mpc.gp.getStore().addSorted(new Ext.data.Record({ts:u,author:sender,message:q,room:null,
jid:mpc.getJidByHandle(sender),xdelay:m,product_id})),mpc.gp.getStore().isFiltered()&&mpc.gp.getStore().filterBy(iembotFilter),m||(Ext.getCmp("__allchats__").gp.getStore().addSorted(new Ext.data.Record({ts:u,author:sender,room:Strophe.getNodeFromJid(f),message:q,jid:mpc.getJidByHandle(sender),xdelay:m,product_id})),Ext.getCmp("__allchats__").gp.getStore().isFiltered()&&Ext.getCmp("__allchats__").gp.getStore().filterBy(iembotFilter)))}else"chat"!=k||q||null==f?"chat"==k&&q&&null!=f?(jid=Strophe.getBareJidFromJid(f),
username=Strophe.getNodeFromJid(f),Strophe.getDomainFromJid(f)!=Application.XMPPHOST&&(jid=f,username=Strophe.getResourceFromJid(f)),cp=Ext.getCmp("chatpanel").getChat(jid),cp||(cp=Ext.getCmp("chatpanel").addChat(jid),Application.MsgBus.fireEvent("soundevent","new_conversation")),cp.gp.store.addSorted(new Ext.data.Record({ts:u,author:username,room:null,xdelay:!1,message:q}))):f==Application.XMPPHOST&&(new Ext.Window({width:500,maxWidth:500,height:350,constrain:!0,autoScroll:!0,bodyStyle:{padding:"10",
background:"#fff"},title:$(d).find("subject").text()||"System Message",html:"<p><b>System Message</b><p>"+$(d).find("body").text()+"</p>"})).show():(jid=Strophe.getBareJidFromJid(f),cp=Ext.getCmp("chatpanel").getChat(jid),0<$(d).find("composing").length&&cp&&cp.setIconCls("typing-tab"),0<$(d).find("paused").length&&cp&&cp.setIconCls("paused-tab"))}
function geomParser(d,f){if(Ext.getCmp("map")){var k=d.getElementsByTagName("body")[0],m=null;0<d.getElementsByTagName("html").length?(m=$(d).find("html").find("body"),m=navigator.userAgent.match(/msie/i)?m[0].xml:$(m[0]).html()):m=Strophe.getText(k);d=$(d).find("x");if(0!=d.length)for(k=0;k<d.length;k++)if(null!=d[k].getAttribute("geometry")){var p=d[k].getAttribute("geometry");wkt=new OpenLayers.Format.WKT;if(collection=wkt.read(p)){collection.constructor!=Array&&(collection=[collection]);var q=
collection[0];p=36E5;if(!d[k].getAttribute("skip")){if(d[k].getAttribute("expire")){var u=UTCStringToDate(d[k].getAttribute("expire"),"Ymd\\Th:i:s");q.attributes.expire=u.toUTC();diff=u-new Date;if(0>=diff)continue;0<diff&&(p=diff)}d[k].getAttribute("valid")&&(u=UTCStringToDate(d[k].getAttribute("valid"),"Ymd\\Th:i:s"),q.attributes.valid=u.toUTC());q.attributes.ptype=d[k].getAttribute("ptype");q.attributes.message=m;q.geometry.transform(new OpenLayers.Projection("EPSG:4326"),new OpenLayers.Projection("EPSG:900913"));
"LSR"!=d[k].getAttribute("category")&&"PIREP"!=d[k].getAttribute("category")||!q.attributes.valid||f&&!(f&&72E5>new Date-q.attributes.valid)||(lsrs.addFeatures([q]),(new Ext.util.DelayedTask(function(){lsrs.removeFeatures([q])})).delay(p),sstate=Application.lsrStore.getSortState(),Application.lsrStore.sort(sstate.field,sstate.direction));"SBW"==d[k].getAttribute("category")&&(q.attributes.vtec=d[k].getAttribute("vtec"),u=Application.sbwStore.find("vtec",q.attributes.vtec),"CAN"==d[k].getAttribute("status")?
-1<u&&(Application.log("Removing SBW vtec ["+q.attributes.vtec+"]"),Application.sbwStore.removeAt(u)):(-1<u&&(Application.log("Old SBW vtec ["+q.attributes.vtec+"]"),Application.sbwStore.removeAt(u)),Application.log("Adding SBW vtec ["+q.attributes.vtec+"] delay ["+p+"]"),sbws.addFeatures([q]),(new Ext.util.DelayedTask(function(){sbws.removeFeatures([q])})).delay(p),sstate=Application.sbwStore.getSortState(),Application.sbwStore.sort(sstate.field,sstate.direction)))}}}}}
function rawInput(d){Application.log("RECV: "+Strophe.xmlescape(d))}function rawOutput(d){Application.log("SENT: "+Strophe.xmlescape(d))};Ext.ns("Application");Application.updateColors=function(){var d=Application.getPreference("bgcolor","FFFFFF"),f=Application.getPreference("fgcolor","000000");Application.log("Attempting style adjustment bgcolor:"+d+", fgcolor:"+f);Ext.getCmp("chatpanel").items.each(function(k){k.te&&k.te.items.get(0).getEl().applyStyles({background:"#"+d,color:"#"+f})})};
Application.syncPreferences=function(){Application.log("Saving preferences to server...");var d=$iq({type:"set",id:"_set1"}).c("query",{xmlns:"jabber:iq:private"}).c("storage",{xmlns:"nwschatlive:prefs"});Application.prefStore.each(function(f){this.c("pref",{key:f.get("key"),value:f.get("value")}).up()},d);void 0!==Application.XMPPConn&&Application.XMPPConn.sendIQ(d.tree())};Application.removePreference=function(d){idx=Application.prefStore.find("key",d);-1<idx&&Application.prefStore.removeAt(idx)};
Application.getPreference=function(d,f){idx=Application.prefStore.find("key",d);return-1<idx?(record=Application.prefStore.getAt(idx),record.get("value")):f};Application.setPreference=function(d,f){idx=Application.prefStore.find("key",d);-1<idx?(Application.log("Setting Preference: "+d+" Value: "+f),record=Application.prefStore.getAt(idx),record.set("value",f)):(Application.log("Adding Preference: "+d+" Value: "+f),Application.prefStore.add(new Ext.data.Record({key:d,value:f})))};
Application.prefStore=new Ext.data.Store({fields:[{id:"key"},{id:"value"}],locked:!1,listeners:{remove:function(d,f,k){Application.log("prefStore remove event fired...");if(d.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences()},update:function(d,f,k){Application.log("prefStore update event fired...");if(d.locked)return Application.log("Skipping preference save due to locking"),!0;Application.syncPreferences();"fgcolor"!=f.get("key")&&"bgcolor"!=
f.get("key")||Application.updateColors()}}});Application.MsgBus=new Ext.util.Observable;Application.MsgBus.addEvents("message");Application.MsgBus.addEvents("loggedin");Application.MsgBus.addEvents("loggedout");
Application.playSound=function(d){if(soundManager&&soundManager.ok()&&1!=soundManager.playState){var f=soundManager.getSoundById(d);if(!f){idx=Application.SoundStore.find("id",d);if(-1==idx){Application.log("Could not find sound: "+d);return}record=Application.SoundStore.getAt(idx);f=soundManager.createSound({id:record.get("id"),url:record.get("src"),onplay:function(){},onfinish:function(){}})}f&&f.play({volume:Application.getPreference("volume",100)})}};
Application.MsgBus.on("soundevent",function(d){enable=Application.getPreference("sound::"+d+"::enabled","true");"false"!=enable&&(sidx=Application.getPreference("sound::"+d+"::sound","default"),Application.playSound(sidx))});
Application.MsgBus.on("loggingout",function(){Ext.getCmp("chatpanel").items.each(function(d){"groupchat"==d.chatType&&d.clearRoom()});Ext.getCmp("buddies").root.removeAll();Ext.getCmp("bookmarks").root.suspendEvents(!1);Ext.getCmp("bookmarks").root.removeAll();Ext.getCmp("bookmarks").root.resumeEvents();Ext.getCmp("bookmarks").root.initalLoad=!1;Ext.getCmp("chatrooms").root.removeAll()});Application.MsgBus.on("loggedout",function(){Ext.getCmp("loginwindow").show()});
Application.MsgBus.on("loggedin",function(){Ext.getCmp("loginwindow").hide();Application.XMPPConn.send($iq({type:"get",id:"fetchrooms",to:"conference."+Application.XMPPHOST}).c("query",{xmlns:"http://jabber.org/protocol/disco#items"}))});
Application.MsgBus.on("joinchat",function(d,f,k){if(null==f||""==f)f=Application.USERNAME;mcp=Ext.getCmp("chatpanel").getMUC(d);if(null==mcp){Application.log("Creating chatroom:"+d);mcp=Ext.getCmp("chatpanel").addMUC(d,f,k);var m=$pres({to:d+"/"+f});k&&m.c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("item").c("role","visitor");Application.XMPPConn.send(m);mcp.on("destroy",function(){Application.XMPPConn.authenticated&&this.joinedChat&&Application.XMPPConn.send($pres({type:"unavailable",to:d+
"/"+f}))})}Ext.getCmp("chatpanel").setActiveTab(mcp)});Ext.ns("Application");
Application.buildAddBuddy=function(d,f,k){Ext.getCmp("addbuddy")||(new Ext.Window({title:"Add Buddy",layout:"form",width:300,height:150,id:"addbuddy",items:[{xtype:"textfield",fieldLabel:"Weather.IM ID",value:d},{xtype:"textfield",fieldLabel:"Alias",value:f},{xtype:"textfield",fieldLabel:"Buddy Group",value:k}],buttons:[{text:"Add Buddy",handler:function(m){var p=m.ownerCt.ownerCt.items.items[0].getValue(),q=m.ownerCt.ownerCt.items.items[1].getValue();m=m.ownerCt.ownerCt.items.items[2].getValue();var u=
$pres({to:p+"@"+Application.XMPPHOST,type:"subscribe"});Application.XMPPConn.send(u.tree());u=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:p+"@"+Application.XMPPHOST,name:q}).c("group",m);Application.XMPPConn.send(u.tree());Ext.getCmp("addbuddy").close()}}]})).show()};
